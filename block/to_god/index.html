<!doctype html>
<html>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script>
    <style type="text/css">
            #category a{
                text-decoration: none; 
                color: black;
            }
            /* #category {line-height: 2em;} */
            .newh{
                padding-top: 0.5em;
                padding-bottom: 0.5em;
            }
            .newh:hover{
                background: #E6F0FE;
            }
        @media (max-width: 1600px) {
            .book-body {
                /* padding-left: 200px; */
                padding-right: 0px;
            }
        }
    
        @media (max-width: 1400px) {
            .book-body {
                /* padding-left: 200px; */
                padding-right: 0px;
            }
        }
    
        @media (max-width: 1200px) {
            .book-body {
                /* padding-left: 300px; */
                padding-left: 0px;
            }
        }
    
        @media (max-width: 700px) {
            .book-body {
                padding-left: 0px;
            }
        }
    
        @media (min-width: 600px) {
            #category {
                /* 绝对定位 */
                position: fixed;
                /* 目录显示的位置 */
                            float: left;
                            margin-right: 2em;
                /* right: 0px; */
                top: 0;
                /* 目录栏的高度,这里设置为60%主要是为了不挡住返回顶部和折叠按钮 */
                height: 93%;
                /* 设置边框这样和正文对比比较明显 */
                border: 0 solid #eaeaea;
                /* 开启垂直滚动条 */
                overflow-y: scroll;
                            width:25%;
                            display:block;
                            /* z-index: 99;; */
                            background: white;
                            
            }
    
            /* 正文的样式 */
            #write {
                width:100%;
                display: block;
                            /* float:right; */
            }
            img{
                display: block;
            }
                    
            code,tt{
                color:#c7254e;
                background-color:#f9f2f4;
            }
                    
            /* 返回顶部按钮样式 */
            #topButton {
                position: fixed;
                float: right;
                right: 20px;
                top: 95%;
                            z-index: 99;
            }
    
            /* 展开或者折叠 */
            #foldOrUnfold {
                position: fixed;
                float: right;
                right: 20px;
                top: 89%;
                            z-index: 99;
            }
        }
    
        @media (-webkit-max-device-pixel-ratio: 1) {
            ::-webkit-scrollbar-track-piece {
                background-color: #FFF
            }
    
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px
            }
    
            ::-webkit-scrollbar-thumb {
                background-color: #c2c2c2;
                background-clip: padding-box;
                min-height: 28px
            }
    
            ::-webkit-scrollbar-thumb:hover {
                background-color: #A0A0A0
            }
        }
            @media (max-width: 599px) {
                #category {
                        /* 绝对定位 */
                        position: fixed;
                        /* 目录显示的位置 */
                        float: left;
                        /* right: 0px; */
                        top: 0;
                        width: 85%;
                        /* 目录栏的高度,这里设置为60%主要是为了不挡住返回顶部和折叠按钮 */
                        height: 90%;
                        /* 设置边框这样和正文对比比较明显 */
                        border: 2px solid #eaeaea;
                        /* 开启垂直滚动条 */
                        overflow-y: scroll;
                        z-index: 99;
                        display: none;
                        background: white;
                        font-size: 20px;
                        /* line-height: 2em; */
                }
                
                /* 正文的样式 */
                #book_body {
                        width: 100%;
                        display: block;
                }
                img{
                    display: block;
                }
                code,tt{
                        color:#c7254e;
                        background-color:#f9f2f4;
                }
    
                /* 返回顶部按钮样式 */
                #topButton {
                        position: fixed;
                        float: right;
                        right: 2%;
                        top: 95%;
                        z-index:99;
                }
    
                /* 目录展开或者折叠 */
                #foldOrUnfold {
                        position: fixed;
                        float: left;
                        right: 4%;
                        top: 90%;
                        z-index:99;
                }
        }
    </style>
    <!--侧栏目录生成代码-->
    <script>
        $(document).ready(function () {
            $("h1,h2,h3,h4,h5,h6").each(function (i, item) {
                //获取标签的名字,h1,还是h2
                var tag = $(item).get(0).localName;
                //为该标签设置id属性
                $(item).attr("id", "wow" + i);
                //添加一个页内超链接,并设置class选择器
                $("#category").append('<div class="newh"><a class="new' + tag + '" href="#wow' + i + '">' + $(item).text() +
                    '</a></div>');
                //为每一个标题超链接的class属性设置左边距
                $(".newh1").css("margin-left", "0em");
                $(".newh2").css("margin-left", "1em");
                $(".newh3").css("margin-left", "2em");
                $(".newh4").css("margin-left", "3em");
                $(".newh5").css("margin-left", "4em");
                $(".newh6").css("margin-left", "5em");
                            $(".newh1").css("font-size", "1.5em");
                            $(".newh2").css("font-size", "1.2em");
                            $(".newh3").css("font-size", "1em");
                            $(".newh4").css("font-size", "0.9em");
                            $(".newh5").css("font-size", "0.8em");
                            $(".newh1").css("font-weight", "bold");
                            $(".newh2").css("font-weight", "bold");
            });
            //设置class选择器为.book-body的html内容
            $(".book-body").html($(".book-body").nextAll())
                    $(".newh").on("click",function(){
                        console.log($(this).children("a"));
                        $(this).children("a")[0].click();
                    });
        });
    </script>
    <script>
        // 展开或者折叠目录功能
        function showOrCloseCategory() {
            var id = document.getElementById("category");
            var write = document.getElementById("write");
                    //console.log(id.style.display);
            //如果展开了
            if (id.style.display == 'block') {
                //console.log("开始展开");
                id.style.display = 'none';
                            write.style.float = "";
                            write.style.left = "0em";
            }
            //如果被折叠了
            else if (id.style.display == 'none') {
                //console.log("开始折叠");
                id.style.display = 'block';
                            write.style.float = "right";
                            write.style.left = "1em";
            }
        }
        // 返回顶部功能
        function topFunction() {
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }
    </script>
    <!--返回顶部-->
    <button onclick="topFunction()" id="topButton">TOP↑</button>
    <button onclick="showOrCloseCategory()" id="foldOrUnfold">目录</button>
    
    <!--文章主体部分-->
    <div class="book-body" id="book_body"> </div>
    <!--目录栏-->
    <div class="book-summary" id="category" style="display:none"></div>
    
    
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<!-- 归家按钮 -->
<link rel="stylesheet" href="./style.css">
<div class="backbtn">
    <a href="https://2384447291.github.io/#blocks" class="btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Home</span>
  </a>
  </div>
<!-- 归家按钮 -->
  
<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}


</style><title>马哥代码详解</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='artinx电控代码框架------超详细解析向马哥致敬salute）'><span>Artinx电控代码框架——超详细解析（向马哥致敬salute）</span></h1><hr /><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n0"><a class="md-toc-inner" href="#artinx电控代码框架------超详细解析向马哥致敬salute）">Artinx电控代码框架——超详细解析（向马哥致敬salute）</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1220"><a class="md-toc-inner" href="#一底层更新逻辑------robotengine和entity">一.底层更新逻辑——RobotEngine和Entity</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4"><a class="md-toc-inner" href="#1robotengine">1.RobotEngine</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n5"><a class="md-toc-inner" href="#综述-1">综述</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n7"><a class="md-toc-inner" href="#何处使用哪里有模板）">何处使用（哪里有模板）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n14"><a class="md-toc-inner" href="#如何使用怎么自己写）">如何使用（怎么自己写）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n24"><a class="md-toc-inner" href="#源码分析-1">源码分析</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n67"><a class="md-toc-inner" href="#2entity">2.Entity</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n68"><a class="md-toc-inner" href="#综述-2">综述</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n70"><a class="md-toc-inner" href="#何处使用哪里有模板--如何使用怎么自己写）">何处使用(哪里有模板) + 如何使用（怎么自己写）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n79"><a class="md-toc-inner" href="#源码分析-2">源码分析</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n121"><a class="md-toc-inner" href="#3整体更新逻辑">3.整体更新逻辑</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n122"><a class="md-toc-inner" href="#systick中断">Systick中断</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n137"><a class="md-toc-inner" href="#流程回顾">流程回顾</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n156"><a class="md-toc-inner" href="#二通讯简介">二.通讯简介</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n158"><a class="md-toc-inner" href="#1通讯的简介">1.通讯的简介</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n162"><a class="md-toc-inner" href="#2通讯的分类">2.通讯的分类</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n163"><a class="md-toc-inner" href="#串行和并行">串行和并行</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n177"><a class="md-toc-inner" href="#全双工半双工和单工">全双工，半双工和单工</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n192"><a class="md-toc-inner" href="#异步通信和同步通信">异步通信和同步通信</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n194"><a class="md-toc-inner" href="#1异步通讯">1.异步通讯</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n224"><a class="md-toc-inner" href="#2同步通讯">2.同步通讯</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n277"><a class="md-toc-inner" href="#3通讯的物理层">3.通讯的物理层</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n301"><a class="md-toc-inner" href="#三can消息收发------canmanagercanmsgdispatcher和canmsghandler">三.Can消息收发——CanManager，CanMsgDispatcher和CanMsgHandler</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n302"><a class="md-toc-inner" href="#1什么是can">1.什么是can</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n305"><a class="md-toc-inner" href="#1差分信号">1.差分信号</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n315"><a class="md-toc-inner" href="#2终端电阻">2.终端电阻</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n354"><a class="md-toc-inner" href="#3硬件结构硬件要听听）">3.硬件结构（硬件要听听）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n358"><a class="md-toc-inner" href="#4can通讯详解can通信讲解---知乎-zhihucom">4.Can通讯详解CAN通信讲解 - 知乎 (zhihu.com)</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n366"><a class="md-toc-inner" href="#41帧起始与振结束">4.1帧起始与振结束</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n372"><a class="md-toc-inner" href="#42仲裁段和仲裁机制">4.2仲裁段和仲裁机制</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n386"><a class="md-toc-inner" href="#43控制段">4.3控制段</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n390"><a class="md-toc-inner" href="#44数据段">4.4数据段</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n392"><a class="md-toc-inner" href="#45crc段">4.5CRC段</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n395"><a class="md-toc-inner" href="#46ack段">4.6ACK段</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n398"><a class="md-toc-inner" href="#47科普位填充">4.7科普位填充</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n408"><a class="md-toc-inner" href="#48can采样点与波特率">4.8CAN采样点与波特率</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n416"><a class="md-toc-inner" href="#5怎么在代码上配置can通讯">5.怎么在代码上配置can通讯</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n417"><a class="md-toc-inner" href="#第一步初始化gpio"><strong>第一步：初始化GPIO</strong></a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n420"><a class="md-toc-inner" href="#第二步配置can中断">第二步：配置CAN中断</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n422"><a class="md-toc-inner" href="#第三步的先验知识can的收发邮箱33条消息-stm32之can---发送管理分析bonson2004的博客-csdn博客">第三步的先验知识can的收发邮箱(33条消息) STM32之CAN---发送管理分析_bonson2004的博客-CSDN博客</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n466"><a class="md-toc-inner" href="#第三步配置滤波器">第三步配置滤波器</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n469"><a class="md-toc-inner" href="#第四步配置时序和位时间和一些基本设置">第四步配置时序和位时间和一些基本设置</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n495"><a class="md-toc-inner" href="#2我们的can通讯">2.我们的CAN通讯</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n496"><a class="md-toc-inner" href="#1先行知识">1.先行知识</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n497"><a class="md-toc-inner" href="#11循环队列">1.1循环队列</a></span></p></div><h2 id='一底层更新逻辑------robotengine和entity'><span>一.底层更新逻辑——RobotEngine和Entity</span></h2><h3 id='1robotengine'><span>1.RobotEngine</span></h3><h4 id='综述-1'><span>综述</span></h4><p><span>RobotEngine是整个机器人的逻辑处理中心，所有的控制器，执行器和传感器都是这个类的成员变量，主要掌管所有成员变量的更新逻辑。</span></p><h4 id='何处使用哪里有模板）'><span>何处使用（哪里有模板）</span></h4><p><span>就像我们之前说的一样，这个变量是主管整个机器人的，他是代码里为数不多实例化在main函数的变量之一。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded md-focus" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap CodeMirror-focused" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 188.4px; left: 285.7px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Testbot</span> : <span class="cm-keyword">public</span> <span class="cm-variable">RobotEngine</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ChassisController</span> <span class="cm-variable">chassisController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Rotate</span> <span class="cm-variable">rotate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ShiftRegisterController</span> <span class="cm-variable">shiftRegisterController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Leveler</span> <span class="cm-variable">leveler</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Testbot</span>() : <span class="cm-variable">RobotEngine</span>(<span class="cm-keyword">this</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">///摘自工程车底盘文件夹里的Testbot.hpp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>这里的Testbot想必老队员都不会很陌生，给新队员介绍一下这个Testbot是对整个机器人进行测试的时候的通用名称。如果定稿了就会取像Sentry（哨兵）和Engineer（工程）这样的名字。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Sentry</span> : <span class="cm-keyword">public</span> <span class="cm-variable">RobotEngine</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ChassisController</span> <span class="cm-variable">chassisController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GimbalController</span> <span class="cm-variable">upGimbalController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GimbalController</span> <span class="cm-variable">downGimbalController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Sentry</span>() : <span class="cm-variable">RobotEngine</span>(<span class="cm-keyword">this</span>), </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">upGimbalController</span>(<span class="cm-variable">GimbalController</span>(<span class="cm-variable">EntityClassType::ECT_UpGimbalController</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">downGimbalController</span>(<span class="cm-variable">GimbalController</span>(<span class="cm-variable">EntityClassType::ECT_DownGimbalController</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">///摘自哨兵底盘文件夹里的Sentry.hpp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>在</span><strong><span>SysTick_Handler</span></strong><span>()函数（这个函数在之后说明，具体可以理解为这个函数固定1ms调用一次）里会调用</span><strong><span>testbot.tick()</span></strong><span>，这个函数执行了所有控制器，传感器等的更新。这就表示了理论上所有控制器，传感器，执行器都会在每个1ms执行一次更新。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">SysTick_Handler</span>(<span class="cm-variable-3">void</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">testbot</span>.<span class="cm-variable">Tick</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...<span class="cm-tab" role="presentation" cm-text="	">  </span></span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-comment">///摘自哨兵底盘文件夹里的Projects/RmBoardA/main.cpp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><h4 id='如何使用怎么自己写）'><span>如何使用（怎么自己写）</span></h4><p><span>1.新建一个类，如果你没有其他的针对于当前兵种的函数需求，则直接新建</span><strong><span>xxx.hpp</span></strong><span>文件，在这个文件里新建一个类继承自</span><strong><span>RobotEngine</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Testbot</span> : <span class="cm-keyword">public</span> <span class="cm-variable">RobotEngine</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>2.导入你所想要实现的控制器，并实例化在它的private子变量里（下图的</span><strong><span>Testbot</span></strong><span>就实现了</span><strong><span>ChassisControllrt</span></strong><span>底盘控制，</span><strong><span>Rotate</span></strong><span>夹爪旋转控制等）。至于为什么没有传感器和执行器，是因为这些对象已近作为控制器的成员变量随控制器嵌入到了系统里。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include "RobotEngine.hpp"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include "ChassisController.hpp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include "GimbalController.hpp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include "Rotate.hpp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include "ShiftRegisterController.hpp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#include "Leveler.hpp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Testbot</span> : <span class="cm-keyword">public</span> <span class="cm-variable">RobotEngine</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ChassisController</span> <span class="cm-variable">chassisController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Rotate</span> <span class="cm-variable">rotate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ShiftRegisterController</span> <span class="cm-variable">shiftRegisterController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Leveler</span> <span class="cm-variable">leveler</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">} &nbsp; &nbsp;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><p><span>3.实现它的构造函数，后面的</span><strong><span>: RobotEngine(this)</span></strong><span>的作用是表示后面是初始化列表、对父类进行初始化。</span></p><p><span>调用格式为“子类构造函数 : 父类构造函数”。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Testbot</span>() : <span class="cm-variable">RobotEngine</span>(<span class="cm-keyword">this</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#endif</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>4.第一次提醒，下面的处理是为了防止在一个文件中重复包含一个头文件</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#ifndef TESTBOT_HPP</span><span class="cm-comment">// 如果没定义TESTBOT_HPP，下面的语句才会编译</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define TESTBOT_HPP</span><span class="cm-comment">// 那么就定义TESTBOT_HPP并编译下面的语句</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#endif</span><span class="cm-comment">//预处理if结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ...</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><h4 id='源码分析-1'><span>源码分析</span></h4><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">RobotEngine</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Entity</span><span class="cm-operator">*</span> <span class="cm-variable">m_EntityList</span>[<span class="cm-variable">ET_LENGTH</span>][<span class="cm-variable">MAX_ENTITIES</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint8_t</span> <span class="cm-variable">m_EntityCount</span>[<span class="cm-variable">ET_LENGTH</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">bool</span> <span class="cm-variable">m_IsRunning</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-variable-3">bool</span> <span class="cm-variable">IsInstantiated</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-variable">RobotEngine</span><span class="cm-operator">*</span> <span class="cm-variable">instance</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//... &nbsp; &nbsp;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p><strong><span>RobotEngine</span></strong><span>类在</span><strong><span>private成员变量</span></strong><span>区维护了一个</span><strong><span>Entity指针类型</span></strong><span>的二维数组（这里的</span><strong><span>Entity</span></strong><span>会在之后解释，这里理解为所有的控制器，传感器，执行器都继承自</span><strong><span>Entiity</span></strong><span>）那么</span><strong><span>m_EntityList</span></strong><span>变量就按各个类型的数目和控制器，传感器，执行器三个类型存储了机器人的所有部分。</span></p><p><strong><span>m_EntityCount</span></strong><span>的存在主要是为了之后遍历</span><strong><span>m_EntityList</span></strong><span>更加方便。</span></p><p><strong><span>m_IsRunning</span></strong><span>是为了防止没有初始化的脏标记（后续解释）。</span></p><p><span>至于</span><strong><span>IsInstantiated</span></strong><span>和</span><strong><span>instance</span></strong><span>牵扯到单例模式。</span></p><p><strong><span>单例</span></strong><span>的字面意思就是只有一个实例。</span><strong><span>单例模式</span></strong><span>是一种编程方法</span><a href='https://blog.csdn.net/qq_38915078/article/details/112667316'><span>(25条消息) 类的static成员咋用？和普通成员变量之间怎么访问？</span><em><span>凡事要上心的博客-CSDN博客</span></em><span>静态成员访问</span></a><span>（大家可以看看这个博客讲的还比较清楚）。我们这里的使用其实是一种变种，其原理其实很简单，就是使用</span><strong><span>static</span></strong><span>关键字包装这个对象的指针，我们这里首先回顾一下</span><strong><span>static</span></strong><span>关键字的特性。</span></p><p><span>对于</span><strong><span>static成员变量</span></strong><span>（也是这里所使用的情况）</span></p><p><span>1.类的所有实体对象共享这个变量</span></p><p><span>2.类的数据成员在类外定义时不加 static</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Test</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">double</span> <span class="cm-variable">d</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">n</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">Test::n</span>; &nbsp;<span class="cm-comment">// 静态成员变量需要在类外声明(分配空间，可以显式初始化，默认初始化为0)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-keyword">sizeof</span>(<span class="cm-variable">Test</span>) <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">Test::n</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><span>静态成员变量存储在全局/静态区，在整个程序结束的时候才会被释放，静态成员变量只有在类外声明时才分配空间，可显式初始化，不显式初始化OS默认初始化为0。</span></p><p><span>静态成员变量属于类不属于对象而是属于整个类，所以sizeof()的结果不包括静态成员变量大小。也是因为同样的原因，它可通过对象调用，也可以通过类名作用域调用(非静态成员变量只能通过对象调用)。</span></p><p>&nbsp;</p><p><span>这两个</span><strong><span>static</span></strong><span>变量的作用具体体现在</span><strong><span>RobotEngine</span></strong><span>类的构造函数上。我们可以理解现在这两个变量不属于某个对象，而是属于整个类。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">RobotEngine::RobotEngine</span>(<span class="cm-variable">RobotEngine</span><span class="cm-operator">*</span> <span class="cm-variable">_instance</span>, <span class="cm-variable">uint32_t</span> <span class="cm-variable">_msPerTick</span>) : <span class="cm-variable">m_EntityList</span>{<span class="cm-keyword">nullptr</span>},</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_EntityCount</span>{<span class="cm-number">0</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_IsRunning</span>{<span class="cm-atom">false</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>这里面的</span><strong><span>_msPerTick</span></strong><span>暂时不用管，是个废案，剩下的参数指针其实是其子类的指针（</span><strong><span>科普</span></strong><span>：对于子类指针强转为父类指针，强转后的指针在调用虚函数时失效，会调用子类的同名函数。若不是虚函数，则调用时会调用父类函数）。我们在构造</span><strong><span>RobotEngine</span></strong><span>对象的时候一般采用构造一个它的子类的方式（把复杂的属性留在内部，外部只留子类的成员变量，方便也美观）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Sentry</span> : <span class="cm-keyword">public</span> <span class="cm-variable">RobotEngine</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Sentry</span>() : <span class="cm-variable">RobotEngine</span>(<span class="cm-keyword">this</span>), </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>使用的时候在main函数文件外面声明一个全局变量(其实在哪个C++文件都可以，反正是全局变量是共同的，放在main只是为了好找)</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Sentry</span> <span class="cm-variable">sentry</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>具体里面主要实现了实例化判断，一开始两个静态变量被初始化为</span><strong><span>false</span></strong><span>和</span><strong><span>nullptr</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++\"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++\"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bool RobotEngine::IsInstantiated = false;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">RobotEngine* RobotEngine::instance = nullptr;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>如果没有被实例化，则将传入的子类实例化的指针赋给静态指针，并把实例化脏标置为</span><strong><span>true</span></strong><span>，下次如果失误再次调用构造函数则不会覆盖第一次的静态指针。我们每次通过静态指针调用的对象始终都是第一次实例化的对象（这就是</span><strong><span>单例模式</span></strong><span>，这里的单例模式的使用其实很奇怪，我们仍可以定义实例化很过个</span><strong><span>RobotEngine</span></strong><span>对象，只是不会被使用，这其实不是我们的初心，之后的另一种单例方式则会更加优雅）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">RobotEngine::RobotEngine</span>(<span class="cm-variable">RobotEngine</span><span class="cm-operator">*</span> <span class="cm-variable">_instance</span>, <span class="cm-variable">uint32_t</span> <span class="cm-variable">_msPerTick</span>) : <span class="cm-variable">m_EntityList</span>{<span class="cm-keyword">nullptr</span>},</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_EntityCount</span>{<span class="cm-number">0</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_IsRunning</span>{<span class="cm-atom">false</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">IsInstantiated</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">instance</span> <span class="cm-operator">=</span><span class="cm-variable">_instance</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">IsInstantiated</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><span>我们接下来继续认识其他成员函数：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">RobotEngine</span><span class="cm-operator">*</span> <span class="cm-def">Instance</span>(){ <span class="cm-keyword">return</span> <span class="cm-variable">instance</span>; }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>承接上面的内容，静态成员变量可以由类名作用域调用，静态成员函数自然也可以，我们通常使用这个函数来访问我们的单例，使用例子如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">RobotEngine::Instance</span>()</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>剩下的函数则是跟</span><strong><span>Entity</span></strong><span>的更新有关</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">RobotEngine::AddEntity</span>(<span class="cm-variable">Entity</span><span class="cm-operator">*</span> <span class="cm-variable">_newEntity</span>, <span class="cm-variable">EntityType</span> <span class="cm-variable">_type</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">m_IsRunning</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>首先是</span><strong><span>m_IsRunning</span></strong><span>脏标的判断，这个脏标主要是对是否调用初始化函数</span><strong><span>Init（）</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">RobotEngine::Init</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">_type</span> <span class="cm-operator">=</span> <span class="cm-variable">ET_SENSOR</span>; <span class="cm-variable">_type</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">ET_LENGTH</span>; <span class="cm-operator">++</span><span class="cm-variable">_type</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">m_EntityCount</span>[<span class="cm-variable">_type</span>]; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_EntityList</span>[<span class="cm-variable">_type</span>][<span class="cm-variable">i</span>]<span class="cm-operator">-&gt;</span><span class="cm-variable">Init</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_EntityList</span>[<span class="cm-variable">_type</span>][<span class="cm-variable">i</span>]<span class="cm-operator">-&gt;</span><span class="cm-variable">SetActive</span>(<span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m_IsRunning</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>这个初始化函数主要是实现了对每个</span><strong><span>Entity</span></strong><span>的</span><strong><span>Init（）</span></strong><span>（其实</span><strong><span>Init（）</span></strong><span>是空函数，估计是留的接口），并调用</span><strong><span>SetActive</span></strong><span>把每个</span><strong><span>Entity</span></strong><span>的私有变量</span><strong><span>IsActive</span></strong><span>脏标设为</span><strong><span>True</span></strong><span>（其实按理来说，没有</span><strong><span>Init()</span></strong><span>就调用</span><strong><span>AddEntity（）</span></strong><span>就现在的框架来讲不会有很严重的结果）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">////承接上面</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">m_EntityCount</span>[<span class="cm-variable">_type</span>] <span class="cm-operator">&gt;=</span> <span class="cm-variable">MAX_ENTITIES</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_newEntity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">SetId</span>(<span class="cm-number">0xFF</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>判断加入的Entity是否超过上限，如果Entity过多会导致一个tick（）函数里需要处理的内容过多，导致处理时间过长，而时钟系统决定每1ms会调用一个tick（）函数，可能会导致时序紊乱的问题。这里的MAX_ENTITIES是32，不知道是不是通过测试得到的。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">////承接上面 &nbsp; &nbsp;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">uint8_t</span> <span class="cm-variable">_id</span> <span class="cm-operator">=</span> <span class="cm-variable">m_EntityCount</span>[<span class="cm-variable">_type</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">_newEntity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">SetId</span>(<span class="cm-variable">_id</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m_EntityList</span>[<span class="cm-variable">_type</span>][<span class="cm-variable">_id</span>] <span class="cm-operator">=</span> <span class="cm-variable">_newEntity</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-operator">++</span><span class="cm-variable">m_EntityCount</span>[<span class="cm-variable">_type</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>接下来就是更新</span><strong><span>m_EntityList</span></strong><span>数组，将对应类别的</span><strong><span>Entity</span></strong><span>总数</span><strong><span>m_EntityCount[_type]</span></strong><span>加一，然后给</span><strong><span>Entity</span></strong><span>赋值</span><strong><span>_Id</span></strong><span>(其实就是加入列表的顺序)。</span></p><p><span>有</span><strong><span>Add</span></strong><span>算法自然有</span><strong><span>Search</span></strong><span>算法</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Entity</span><span class="cm-operator">*</span> <span class="cm-def">RobotEngine::GetEntity</span>(<span class="cm-variable">EntityClassType</span> <span class="cm-variable">_classType</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">_type</span> <span class="cm-operator">=</span> <span class="cm-variable">ET_SENSOR</span>; <span class="cm-variable">_type</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">ET_LENGTH</span>; <span class="cm-operator">++</span><span class="cm-variable">_type</span>)<span class="cm-comment">////这里的ET_LENGTH为3，具体实现方式为enum的数字表示，极其优雅，对于该列表，enum EntityType{ET_SENSOR = 0, ET_CONTROLLER, ET_ACTUATOR, ET_LENGTH};ET_LENGTH刚好为3即enum的长度，ET_SENSOR = 0。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">m_EntityCount</span>[<span class="cm-variable">_type</span>]; <span class="cm-operator">++</span><span class="cm-variable">i</span>)<span class="cm-comment">////过于（bushi）谨慎的判断，很有马哥的风格</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">m_EntityList</span>[<span class="cm-variable">_type</span>][<span class="cm-variable">i</span>]<span class="cm-operator">-&gt;</span><span class="cm-variable">GetClassType</span>() <span class="cm-operator">==</span> <span class="cm-variable">_classType</span>)<span class="cm-comment">////过于（bushi）谨慎的判断，很有马哥的风格</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">m_EntityList</span>[<span class="cm-variable">_type</span>][<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">nullptr</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 358px;"></div><div class="CodeMirror-gutters" style="display: none; height: 358px;"></div></div></div></pre><p><span>双重遍历二维数组，找到第一个符合的Entity，否则就返回空。（这个函数的实现，我不好评价毫无意义）。</span></p><p><span>最后一个函数极其重要</span><strong><span>Tick（）</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">RobotEngine::Tick</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">_type</span> <span class="cm-operator">=</span> <span class="cm-variable">ET_SENSOR</span>; <span class="cm-variable">_type</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">ET_LENGTH</span>; <span class="cm-operator">++</span><span class="cm-variable">_type</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">m_EntityCount</span>[<span class="cm-variable">_type</span>]; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Entity</span><span class="cm-operator">*</span> <span class="cm-variable">_entity</span> <span class="cm-operator">=</span> <span class="cm-variable">m_EntityList</span>[<span class="cm-variable">_type</span>][<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">IsActive</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Entity::Update</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">NeedUpdate</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Update</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ClearUpdateFlag</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 493px;"></div><div class="CodeMirror-gutters" style="display: none; height: 493px;"></div></div></div></pre><p><span>大概就是把</span><strong><span>m_EntityCount</span></strong><span>二维数组里所有的</span><strong><span>Entity</span></strong><span>都更新（</span><strong><span>调用Update（）函数</span></strong><span>）（至于更新准则，在</span><strong><span>Entity</span></strong><span>类里面赘述）。</span><strong><span>重要点：</span></strong><span>这个函数每个1ms被调用一次，至于为什么在最后的综述讲。</span></p><h3 id='2entity'><span>2.Entity</span></h3><h4 id='综述-2'><span>综述</span></h4><p><strong><span>Entity</span></strong><span>类是所有传感器，控制器，执行器的父类。而这三个类则是像</span><strong><span>Motor</span></strong><span>，</span><strong><span>ChassisController</span></strong><span>这种类的父类之一。为所有延伸的类提供函数接口</span><strong><span>Update（）</span></strong></p><h4 id='何处使用哪里有模板--如何使用怎么自己写）'><span>何处使用(哪里有模板) + 如何使用（怎么自己写）</span></h4><p><span>就像我们在上面说的</span><strong><span>Entity</span></strong><span>是所有类的主类，它有三种变种分别是传感器，控制器和执行器</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">SensorEntity</span> : <span class="cm-keyword">public</span> <span class="cm-variable">Entity</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">ControllerEntity</span> : <span class="cm-keyword">public</span> <span class="cm-variable">Entity</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ControllerEntity</span>(<span class="cm-variable">EntityClassType</span> <span class="cm-variable">_classType</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable-3">void</span> <span class="cm-variable">Init</span>(){}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">ActuatorEntity</span> : <span class="cm-keyword">public</span> <span class="cm-variable">Entity</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ActuatorEntity</span>(<span class="cm-variable">EntityClassType</span> <span class="cm-variable">_classType</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable-3">void</span> <span class="cm-variable">Init</span>(){}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p><span>对应到我们写的的类，则是要记住依照其类别继承对应的父类，在写构造函数的时候对应调用其父类的构造函数</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Motor</span> : <span class="cm-keyword">public</span> <span class="cm-variable">ActuatorEntity</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Motor</span>(<span class="cm-variable">EntityClassType</span> <span class="cm-variable">_classType</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ActuatorEntity</span>(<span class="cm-variable">_classType</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">controlMode</span>{<span class="cm-variable">RELAX_MODE</span>},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">pFeedback</span>{<span class="cm-keyword">nullptr</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><span>并重载其留下的两个虚函数接口</span><strong><span>Init()</span></strong><span>和</span><strong><span>Update()</span></strong><span>，其实也可以不用重载，看需求。因为它不是纯虚函数</span><a href='https://blog.csdn.net/wcc27857285/article/details/111635976'><span>(25条消息) C++ 虚函数、纯虚函数、重载、重写的区别</span><em><span>Bird鸟人的博客-CSDN博客</span></em><span>虚函数重载和重写</span></a><span>所以不需要强制重载。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//摘自G6020.cpp</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">G6020::Update</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-comment">////这个类就没有重载Init()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//摘自M3508SensorHandler.cp</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">M3508SensorHandler::Init</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">SetCanTimeout</span>(<span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">M3508SensorHandler::Update</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-comment">////这个类就重载了Init()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 358px;"></div><div class="CodeMirror-gutters" style="display: none; height: 358px;"></div></div></div></pre><p><span>像这样的写法，就是纯虚函数，子类必须重载这个函数。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Motor</span> : <span class="cm-keyword">public</span> <span class="cm-variable">ActuatorEntity</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable-3">void</span> <span class="cm-variable">Update</span>() <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><h4 id='源码分析-2'><span>源码分析</span></h4><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Entity</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">RobotEngine</span><span class="cm-operator">*</span> <span class="cm-variable">m_pOwner</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//...</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>这个成员变量主要只为了记录对应</span><strong><span>Entity</span></strong><span>被加载到了哪个</span><strong><span>RobotEngine</span></strong><span>里，会在构造函数的时候被赋值。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint8_t</span> <span class="cm-variable">m_EntityId</span>;<span class="cm-comment">////依据加载顺序赋的Id(上面有讲)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">m_LastUpdateTick</span>;<span class="cm-comment">////跟Entity更新Update()函数有关的防止超时的变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">m_TicksToUpdate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">m_DefaultTicksToUpdate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">EntityClassType</span> <span class="cm-variable">m_ClassType</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">bool</span> <span class="cm-variable">m_IsActive</span>;<span class="cm-comment">////跟更新有关的两个脏标</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">bool</span> <span class="cm-variable">m_NeedUpdate</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>函数回顾</span><strong><span>Tick（）</span></strong><span>：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">双重for循环：</span> &nbsp;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">Entity</span><span class="cm-operator">*</span> <span class="cm-variable">_entity</span> <span class="cm-operator">=</span> <span class="cm-variable">m_EntityList</span>[<span class="cm-variable">_type</span>][<span class="cm-variable">i</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">IsActive</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>这个判断可以大致理解为：如果当前遍历到的</span><strong><span>Entity</span></strong><span>没有被</span><strong><span>Active</span></strong><span>，则跳过它。</span><strong><span>IsActive()</span></strong><span>函数返回的是</span><strong><span>Entity</span></strong><span>的私有变量</span><strong><span>bool m_IsActive；</span></strong><span>，这个变量在</span><strong><span>RobotEngine</span></strong><span>的</span><strong><span>Init（）函数</span></strong><span>里的全被初始化为</span><strong><span>True</span></strong><span>，考虑到</span><strong><span>m_IsActive</span></strong><span>是</span><strong><span>Entity</span></strong><span>的私有变量，能操作它的只有</span><strong><span>Entity</span></strong><span>的函数：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">SetActive</span>(<span class="cm-variable-3">bool</span> <span class="cm-variable">_state</span>){ <span class="cm-variable">m_IsActive</span> <span class="cm-operator">=</span> <span class="cm-variable">_state</span>; }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>但整个代码框架的各种版本都没有调用这个函数，所以其实不用过多考虑。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">////承接上面的Tick（）函数</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Entity::Update</span>();</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>回顾一下上面的虚函数性质：这里的</span><strong><span>_entity</span></strong><span>是强转成父类的子类指针，如果不加处理直接调用由于</span><strong><span>virtual</span></strong><span>关键字调用的其实是子类的</span><strong><span>Update()</span></strong><span>，但这里由于</span><strong><span>Entity：：</span></strong><span>作用域的使用则是父类的</span><strong><span>Update()</span></strong><span>函数。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">Entity::Update</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">m_IsActive</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;<span class="cm-comment">////如果该Entity没有被激活自然不需要进入更新判断函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">m_NeedUpdate</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;<span class="cm-comment">////如果已近确定要NeedUpdate自然不需要进入更新判断函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">m_TicksToUpdate</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">--</span><span class="cm-variable">m_TicksToUpdate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_LastUpdateTick</span> <span class="cm-operator">=</span> <span class="cm-variable">m_pOwner</span><span class="cm-operator">-&gt;</span><span class="cm-variable">GetTick</span>();<span class="cm-comment">////每个Tick()/每过1ms， &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ////m_TicksToUpdate减一</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-number">0</span> <span class="cm-operator">==</span> <span class="cm-variable">m_TicksToUpdate</span>)<span class="cm-comment">////当更新缓冲时间m_TicksToUpdate等于0，确认NeedUpdate脏标置True</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">m_NeedUpdate</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 538px;"></div><div class="CodeMirror-gutters" style="display: none; height: 538px;"></div></div></div></pre><p><span>这个函数主要是为了判断该</span><strong><span>Entity</span></strong><span>是否需要更新，每个</span><strong><span>Entity</span></strong><span>都有一个属性叫做</span><strong><span>m_TicksToUpdate</span></strong><span>，这个变量主要是表示：还有多久时间后才会更新该</span><strong><span>Entity</span></strong><span>。所有的</span><strong><span>Entity</span></strong><span>的更新都需要进行脏标判断,如下述代码：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">NeedUpdate</span>())</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Update</span>();<span class="cm-comment">////这里调用的才是子类自己实现的Update()函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ClearUpdateFlag</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>上述代码函数</span><strong><span>ClearUpdateFlag();</span></strong><span>除了实现了脏标恢复（把</span><strong><span>m_NeedUpdate</span></strong><span>置为</span><strong><span>false</span></strong><span>）还实现了缓冲时间</span><strong><span>m_TicksToUpdate</span></strong><span>重置，这个值一般是1ms，就是说明，2ms才更新一次Entity，特殊情况会延长这个时间（一般是因为处理数据太多，太频繁更新会堵塞，哨兵里面就是这样的）。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">Entity::Suspend</span>(<span class="cm-variable">uint32_t</span> <span class="cm-variable">_ticks</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m_TicksToUpdate</span> <span class="cm-operator">=</span> <span class="cm-variable">_ticks</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m_NeedUpdate</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>与</span><strong><span>m_TicksToUpdate</span></strong><span>配套的还有</span><strong><span>Suspend</span></strong><span>（翻译：</span><strong><span>悬挂</span></strong><span>）函数，该函数主要是更改缓冲时间</span><strong><span>m_TicksToUpdate</span></strong><span>，实现将某一个</span><strong><span>Entity</span></strong><span>挂在一边不处理一段时间。</span></p><p><span>对于</span><strong><span>Entity</span></strong><span>的三个变种，执行器和控制器没有什么特殊的地方，传感器会有一些特殊属性。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">SensorEntity::SensorEntity</span>(<span class="cm-variable">EntityClassType</span> <span class="cm-variable">_classType</span>) :</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Entity</span>(<span class="cm-variable">ET_SENSOR</span>, <span class="cm-variable">_classType</span>, <span class="cm-variable">RobotEngine::Instance</span>()),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m_CanTimeout</span>(<span class="cm-atom">false</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m_LastUpdateTick</span>(<span class="cm-number">0</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m_TimeoutTick</span>(<span class="cm-number">100</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>这些变量会对是否更新传感器起到重要作用：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">////承接上面的Tick（）函数</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span class="cm-variable">_entity</span><span class="cm-operator">-&gt;</span><span class="cm-variable">GetEntityType</span>() <span class="cm-operator">==</span> <span class="cm-variable">ET_SENSOR</span>)<span class="cm-comment">////判断Entity是不是Sensor</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">SensorEntity</span><span class="cm-operator">&amp;</span> <span class="cm-variable">_sensor</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">SensorEntity</span><span class="cm-operator">*</span>)(<span class="cm-variable">_entity</span>);<span class="cm-comment">////和其他直接用指针不同，这里使用引用。原因是：我们在之前把所有子类指针强转成了父类指针，导致这个被强制转化的指针不能访问专属于子类SensorEntity的一些特殊属性。这里就有同学会问：为什么我们不直接强转回去呢？那就破坏了我们m_EntityList里面的东西，这是我们不想看到的。同时我们也不想再次创造一个新变量或者新指针（毕竟谁会知道会发生什么），那我们就使用引用就完美解决了这些问题。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">if</span>(<span class="cm-variable">_sensor</span>.<span class="cm-variable">CanTimeout</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">if</span>(<span class="cm-variable">_sensor</span>.<span class="cm-variable">HasNewData</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">_sensor</span>.<span class="cm-variable">ClearUpdateFlag</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><p><span>我们接着来看这个函数：首先是第一个函数</span><strong><span>CanTimeout()</span></strong><span>：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">bool</span> <span class="cm-def">CanTimeout</span>() <span class="cm-keyword">const</span> { <span class="cm-keyword">return</span> <span class="cm-variable">m_CanTimeout</span>; }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>继续溯源，操作这个</span><strong><span>Entity</span></strong><span>的私有变量的只有函数</span><strong><span>SetCanTimeout()</span></strong><span>:（小技巧：想看一个变量在哪里被使用了，除了</span><strong><span>crtl+F</span></strong><span>搜索这个</span><strong><span>变量</span></strong><span>还要搜索能操作它的</span><strong><span>set函数</span></strong><span>）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">SetCanTimeout</span>(<span class="cm-variable-3">bool</span> <span class="cm-variable">_canTimeout</span>) { <span class="cm-variable">m_CanTimeout</span> <span class="cm-operator">=</span> <span class="cm-variable">_canTimeout</span>; }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>那么哪里调用了</span><strong><span>SetCanTimeout()</span></strong><span>捏？</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">G6020SensorHandler::Init</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">SetCanTimeout</span>(<span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">M2006SensorHandler::Init</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">SetCanTimeout</span>(<span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">M3508SensorHandler::Init</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">SetCanTimeout</span>(<span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><p><span>只有这三个使用can通讯的电机对应的传感器调用了这个函数将</span><strong><span>m_CanTimeout</span></strong><span>置为</span><strong><span>True</span></strong><span>，并且之后再没有调过函数将这个值改回</span><strong><span>False</span></strong><span>，那么我们就可以理解为这个判断里面的操作是针对于这三类can协议传感器的特殊操作：</span><strong><span>（就是判断这个ET_SENSOR是否会出现can信息等待超时的问题，换句话来说就是受到新的can消息就需要马上处理，不需要进行之前所说的m_TicksToUpdate缓冲时间的等待）</span></strong><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span class="cm-variable">_sensor</span>.<span class="cm-variable">HasNewData</span>())</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">_sensor</span>.<span class="cm-variable">ClearUpdateFlag</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>好的接下来我们去找</span><strong><span>HasNewData()</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable-3">bool</span> <span class="cm-def">HasNewData</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">bool</span> <span class="cm-variable">_dataReadyShadow</span> <span class="cm-operator">=</span> <span class="cm-variable">newDataReady</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">newDataReady</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">_dataReadyShadow</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>我们可以知道这个函数返回的是</span><strong><span>newDataReady</span></strong><span>的bool值。我们再去找</span><strong><span>newDataReady</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable-3">void</span> <span class="cm-def">HandleNewCanRxMsg</span>(<span class="cm-variable">CanRxMsg</span><span class="cm-operator">*</span> <span class="cm-variable">_msg</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CanMsgHandler::HandleNewCanRxMsg</span>(<span class="cm-variable">_msg</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">newDataReady</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ClearUpdateFlag</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><span>可喜可贺，我们到头了，当传感器接受到了新的信息，就回把</span><strong><span>newDataReady</span></strong><span>置为</span><strong><span>True</span></strong><span>。</span></p><p><span>于是这整个函数我们可以理解为：如果这类需要特殊处理can信号的传感器收到了新的can消息马上执行</span><strong><span>ClearUpdateFlag()</span></strong><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">ClearUpdateFlag</span>() { <span class="cm-variable">m_LastUpdateTick</span> <span class="cm-operator">=</span> <span class="cm-variable">Time::GetTick</span>(); }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>坏了跟我们想的不一样，并没有做处理（其实我也不知道为什么不做提前更新处理，我觉得可以做的其实），这里留个念想吧，能做提前更新处理的有两种方式（不清楚的回顾一下前面的</span><strong><span>void Entity::Update()</span></strong><span>）</span><strong><span>要么直接m_NeedUpdate = true;要么m_TicksToUpdate = 0</span></strong><span>。但这个处理不是完全没有作用。</span></p><p><strong><span>SensorEntity</span></strong><span>其实还有一个特殊函数</span><strong><span>IsTimeout()</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">bool</span> <span class="cm-def">SensorEntity::IsTimeout</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">m_CanTimeout</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">Time::GetTick</span>() <span class="cm-operator">&gt;</span> <span class="cm-variable">m_LastUpdateTick</span> <span class="cm-operator">+</span> <span class="cm-variable">m_TimeoutTick</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>这个函数因为也有</span><strong><span>if(!m_CanTimeout)</span></strong><span>同样是针对于那些会出现can信息等待超时的问题的</span><strong><span>SensorEntity</span></strong><span>，如果不是这类</span><strong><span>Sensor</span></strong><span>那么直接返回</span><strong><span>True</span></strong><span>。他返回的是判断是否距离上次更新时间超过了</span><strong><span>m_TimeoutTick</span></strong><span>（100ms）。（</span><strong><span>小提示</span></strong><span>：Time::GetTick()返回的是挂墙时钟，就是从上电开始过了多长时间）。那么这个</span><strong><span>IsTimeout()</span></strong><span>有什么用呢？</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-operator">!</span><span class="cm-variable">m_ChassisWheel</span>[<span class="cm-variable">CWT_RightFront</span>].<span class="cm-variable">sensorFeedBack</span>.<span class="cm-variable">IsTimeout</span>())</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Led::On</span>(<span class="cm-variable">Led::DebugA0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Led::Off</span>(<span class="cm-variable">Led::DebugA0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }<span class="cm-comment">////摘自ChassisController.cpp</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><span>这个函数的意思是，在</span><strong><span>ChassisController</span></strong><span>的更新过程中会判断对应轮子的传感器有没有出现can消息超时的问题，如果这类Sensor一直受到新的消息</span><strong><span>m_LastUpdateTick</span></strong><span>会一直更新，那么</span><strong><span>Time::GetTick()</span></strong><span>就不可能大于</span><strong><span>m_LastUpdateTick + m_TimeoutTick</span></strong><span>。</span><strong><span>IsTimeout()</span></strong><span>返回为</span><strong><span>False</span></strong><span>，Led就会亮。这里其实是一个状态指示灯，如果电调（传感器）不出问题，那么对应的四盏灯全会亮，如果出了问题（can消息很长时间没有更新），那么对应的灯就会熄灭。（至于为什么出问题灭灯不是亮灯，我怀疑是因为A板上面的灯是绿色的缘故）</span></p><h3 id='3整体更新逻辑'><span>3.整体更新逻辑</span></h3><h4 id='systick中断'><span>Systick中断</span></h4><p><span>这里我们需要科普一个很重要的东西</span><strong><span>SysTick中断</span></strong><span>。看过我们之前B站视频</span><a href='https://www.bilibili.com/video/BV1Qe4y1n7of/?spm_id_from=333.999.0.0&amp;vd_source=84573173e04f0b3739616dc44db2699a'><span>【2023招新培训】嵌入式编程漫漫漫慢慢慢谈</span><em><span>哔哩哔哩</span></em><span>bilibili</span></a><span>的同学应该知道开发版的CPU的工作模式只有两种：1.线程模式（main函数里面的内容）2.中断模式。</span></p><p><span>这里我不过多赘述，具体可以去17:12开始看。总结成一句话：线程模式（main函数）里的内容不重要,最终都会进入死循环。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>(<span class="cm-variable-3">void</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//....</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//....<span class="cm-tab" role="presentation" cm-text="	">  </span></span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">while</span> (<span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><p><span>重要的是中断，而其中最重要的一个中断是SysTick中断：（这里有些人听的时候可能讲错了）：</span></p><p><strong><span>SysTick 定时器是自减定时器</span></strong><span>（讲的时候讲成递增了，但原理是一样的），我们在初始化调用。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">SysTick_Init</span>(<span class="cm-variable">uint32_t</span> <span class="cm-variable">tick_ms</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp;<span class="cm-variable">SysTick_CLKSourceConfig</span>(<span class="cm-variable">SysTick_CLKSource_HCLK_Div8</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">reload</span> <span class="cm-operator">=</span> <span class="cm-variable">SystemCoreClock</span> <span class="cm-operator">/</span> <span class="cm-number">8000</span> <span class="cm-operator">*</span> <span class="cm-variable">tick_ms</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp;<span class="cm-variable">SysTick</span><span class="cm-operator">-&gt;</span><span class="cm-variable">CTRL</span> <span class="cm-operator">|=</span> <span class="cm-variable">SysTick_CTRL_TICKINT_Msk</span>; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Enable SysTick Interrupt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp;<span class="cm-variable">SysTick</span><span class="cm-operator">-&gt;</span><span class="cm-variable">LOAD</span> <span class="cm-operator">=</span> <span class="cm-variable">reload</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp;<span class="cm-variable">SysTick</span><span class="cm-operator">-&gt;</span><span class="cm-variable">CTRL</span> <span class="cm-operator">|=</span> <span class="cm-variable">SysTick_CTRL_ENABLE_Msk</span>; <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Enable SysTick</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><strong><span>SysTick-&gt;CTRL</span></strong><span>,</span>
<span>控制和状态寄存器, 位[0]是使能位; 位[1]TICKINT 计数将为0时是否触发SysTick Handler;</span></p><p><strong><span>SysTick-&gt;LOAD</span></strong><span>,</span>
<span>重装载寄存器， 作用是当计数减为0时，将特定的初始值装载到当前值寄存器中。</span></p><p><strong><span>SysTick-&gt;VAL</span></strong><span>,</span>
<span>当前值寄存器， 当前计数值，每一次系统中断就减小1。（我们可以拿到这个定时器内部的值）</span></p><p><strong><span>SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK_Div8);</span></strong><span>这个函数表示Systick系统滴答计时器使用的递减频率是内核频率的八分之一。</span></p><p><img src="马哥代码详解.assets/Systick工作原理.jpg" alt="Systick工作原理" style="zoom:15%; " /></p><p><span>那么就会在每1ms执行一次</span><strong><span>Systick_hadler</span></strong><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">SysTick_Handler</span>(<span class="cm-variable-3">void</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Disable all interrupt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">__set_PRIMASK</span>(<span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//....</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">testbot</span>.<span class="cm-variable">Tick</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//....</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Enable all interrupt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">__set_PRIMASK</span>(<span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><strong><span>Systick_hadler</span></strong><span>里面的函数其他暂时不用管，具体只有这三句，先禁止外部终端，优先处理内部终端和一些重要的函数，再允许外部中断，其中最重要的就是</span><strong><span>testbot.Tick();</span></strong><span>，这个就是我们之前一直在讲的</span><strong><span>RobotEngine::Tick()</span></strong><span>函数。也就可以理解每1ms调用一个</span><strong><span>RobotEngine::Tick()</span></strong><span>函数，更可以理解为所有</span><strong><span>Entity</span></strong><span>的最快Update是1ms。</span></p><h4 id='流程回顾'><span>流程回顾</span></h4><p><span>我们再次回顾整个流程：</span></p><p><span>一个RobotEngine的子类中的</span><strong><span>Entity类成员</span></strong><span>会在RobotEngine::Tick()被调用的时候执行</span><strong><span>其</span></strong><span>虚函数Update()，假如</span><strong><span>该Entity类</span></strong><span>有其他Entity类成员，该Entity类成员的虚函数Update()也会被执行。同理，RobotEngine::Init()被调用的时候，所有注册了的Entity类的Init()函数也会被调用，示例见下列伪代码：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">M3508Sensor</span> : <span class="cm-keyword">public</span> <span class="cm-variable">SensorEntity</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable">Init</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable">Update</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">M3508</span> : <span class="cm-keyword">public</span> <span class="cm-variable">ActuatorEntity</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">M3508Sensor</span> <span class="cm-variable">m_Sensor</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable">Update</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">ChassisController</span> : <span class="cm-keyword">public</span> <span class="cm-variable">ControllerEntity</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">M3508</span> <span class="cm-variable">m_Motors</span>[<span class="cm-number">4</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable">Init</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">virtual</span> <span class="cm-variable">Update</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">TestBot</span> : <span class="cm-keyword">public</span> <span class="cm-variable">RobotEngine</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ChassisController</span> <span class="cm-variable">m_ChassisController</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">TestBot</span> <span class="cm-variable">testbot</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">SysTick_Handler</span>(<span class="cm-variable-3">void</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">testbot</span>.<span class="cm-variable">Tick</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">testbot</span>.<span class="cm-variable">Init</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1098px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1098px;"></div></div></div></pre><p><span>继承树如下图所示：</span></p><p><img src="马哥代码详解.assets/Entity继承图.png" referrerpolicy="no-referrer" alt="Entity继承图"></p><p><span>每次在SysTick中断中，testbot.Tick();被调用的时候，会执行4个M3508Sensor的Update()函数，更新电机传感器的反馈；ChassisController的Update()函数，根据控制逻辑控制4个电机的速度或是位置；以及4个M3508的Update()函数，计算出电机具体的控制电流并且发送出去。（</span><strong><span>其实不严谨，看了上面的文章就会知道会有个缓冲时间。</span></strong><span>）</span></p><p><span>Entity类的</span><strong><span>SetDefaultTicksToUpdate(uint32_t _defaultTicks)</span></strong><span>成员函数可以将该Entity类的Update之间的时间设置为defaultTicks个tick(一个tick默认1毫秒)；</span><strong><span>Suspend(uint32_t _ticks)</span></strong><span>成员函数可以让该Entity类暂停更新ticks个tick。</span></p><p><span>RobotEngine类的GetEntity()成员函数可以获取某个类型的Entity的指针。</span></p><p>&nbsp;</p><p><span>核心代码在RobotEngine.hpp, RobotEngine.cpp, Entity.cpp以及EntityType.hpp里。最核心的成员函数是RobotEngine::Tick()，会遍历所有记录下来的Entity，检查是否应该在当前执行其Update()成员函数。</span></p><p><span>Tick()应该每个Systick都调用一次。</span></p><p><span>有三种类型的Entity，分别是SensorEntity，ControllerEntity和ActuatorEntity，每次调用Tick()时，只有在所有SensorEntity都遍历了之后才会开始遍历ControllerEntity，同样，遍历完所有ControllerEntity才会遍历ActuatorEntity。相同类型的Entity之间执行顺序不确定。</span></p><p><span>把Entity注册到RobotEngine的过程有点hack，考虑以下伪代码：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">A</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">A</span>(){ <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-string">"A"</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">B</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">A</span> <span class="cm-variable">a</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">B</span>(){ <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-string">"B"</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">C</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">C</span>(){ <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-string">"C"</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">D</span> : <span class="cm-keyword">public</span> <span class="cm-variable">C</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">B</span> <span class="cm-variable">b</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">D</span>(){ <span class="cm-variable">cout</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-string">"D"</span> <span class="cm-operator">&lt;&lt;</span> <span class="cm-variable">endl</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">D</span> <span class="cm-variable">d</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 672px;"></div><div class="CodeMirror-gutters" style="display: none; height: 672px;"></div></div></div></pre><p><span>运行结果应该为：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">C</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">A</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">B</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">D</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>个人经验，这个问题几乎是所有互联网大厂C++面试笔试必考题，我在参加字节跳动、腾讯、米哈游、西山居、育碧面试的时候，都被问到过这个问题。</span></p><p><span>这套代码框架中，A为某个Entity类，B为另一个Entity类，C为RobotEngine类，D为RobotEngine的衍生类(例如TestBot类)，具体注册过程可以通过看Entity类与RobotEngine类的构造函数搞明白。</span></p><h2 id='二通讯简介'><span>二.通讯简介</span></h2><p><span>这一章主要是为了之后的通讯章节打下基础</span></p><h3 id='1通讯的简介'><span>1.通讯的简介</span></h3><p><a href='https://cloud.tencent.com/developer/article/2027181'><span>计算机网络基础（二）：网络数据通信基础 - 腾讯云开发者社区-腾讯云 (tencent.com)</span></a><span>（好博客）</span></p><p><span>计算机与外界的数据交换称为通信，针对于我们打比赛所需要的通讯主要分为三类：单片机与单片机之间的通讯，单片机与PC端的通讯，单片机与外设（包括电机电调类的输出类型和遥控器类的输入类型）之间的通讯。</span></p><p><span>我们接着关注于协议这个词（针对于我们的比赛，协议可以理解不同之间硬件信号传输的规则），为了达成双方的通讯这里就设计到了两个问题，怎么传输和怎么理解信息）</span></p><h3 id='2通讯的分类'><span>2.通讯的分类</span></h3><h4 id='串行和并行'><span>串行和并行</span></h4><p><span>常见的信号传输可以分为两种：串行通讯和并行通讯</span></p><p><img src="马哥代码详解.assets/串行通讯.png" alt="串行通讯" style="zoom:200%;" /></p><p><span>串行通信指各个数据按传送位顺序进行传输，最少只需要两个传输线即可完成，就是我们通常讲的RT（receive）和TX（Transmit）（这句话其实不是很完善，其实一条线就足够，后面会补充）。</span></p><p><img src="马哥代码详解.assets/串行.png" referrerpolicy="no-referrer" alt="串行"><span>简单点理解就是数据的出口只有一条，这些数据按照一定的顺序一位一位的向外输出。</span></p><p><img src="马哥代码详解.assets/并行通讯.png" alt="并行通讯" style="zoom:200%;" /></p><p><span>并行通信：并行通信指各个数据位同时进行传送的数据通信方式，因此有多少个数据位，就需要多少根数据线。</span></p><p><img src="马哥代码详解.assets/并行.png" referrerpolicy="no-referrer" alt="并行"></p><p><span>简单点理解就是数据的出口不只有一条，这些数据按照一定的组合一排一排的向外输出。</span></p><p><span>这种线束不同和传输规则不同就导致了不同的特点, 我们可以用公路来进行类比，并行通讯就像多车道的公路，可以同时多辆车同时通讯，这就意味着使用并行通讯时可以同时传输多个数据位的数据。串行通讯就像单行道一样，同一时间只允许一辆车通过，也就是说利用串行通讯时每次只能传输一个数据位的数据。很明显，由于并行通讯同一时间传输的数据多，所以并行通讯在数据传输速率上比串行通讯快:</span></p><p><img src="马哥代码详解.assets/对比.png" referrerpolicy="no-referrer" alt="对比"></p><p><span>（队里使用的通讯协议主要为IIC，SPI，CAN，UART这些都为串行通讯）</span></p><p><img src="马哥代码详解.assets/通讯分类.png" referrerpolicy="no-referrer" alt="通讯分类"></p><p><strong><span>所以我们接下来谈的通讯方式都为串行通讯</span></strong><span>)</span></p><h4 id='全双工半双工和单工'><span>全双工，半双工和单工</span></h4><p><span>在串行通信中，数据是在两个站之间传输的。按照数据传输方向，串行通信可分为</span><strong><span>半双工</span></strong><span>和</span><strong><span>全双工</span></strong><span>两种制式。</span></p><ul><li><span>单工通信 只能接受或者发送 收音机 遥控器，一般只有一根线</span></li><li><span>半双工通信 在同一时刻只能发送或者接收 对讲机，至少有一根线</span></li><li><span>全双工通信 在同一时刻 既能接收又能发送 电话，至少有两根线</span></li></ul><p><img src="马哥代码详解.assets/全双工和半双工.png" referrerpolicy="no-referrer" alt="全双工和半双工"></p><p><span>对于串口通讯，全双工和半双工体现的更加直接。最简串口通信需一条线就够，但必须有一条GND（提供一个基准的0V电压），一共需要两条线。（这里就回答了之前的问题）但这一条线中有收/发信号，那收/发就不能同时进行，要分别进行，这属于半双工通信。需要全双工通信，那收/发信号就应分开，因此，最简串口线只需3条，RXD，TXD，GND。</span></p><p><span>这里科普一下，我之前做过的一个项目就涉及到了这个问题：</span></p><p><img src="马哥代码详解.assets/Dynamixel（双工）.png" alt="Dynamixel（双工）" style="zoom:200%;" /></p><p><span>Dynamixel系列的舵机是使用一种读写RAM的通信协议（插到舵机上的有三条线，VCC，GND和DATA）。这种通信基于半双工UART端口，只需要一根总线（就是那个DATA接口）便可以同时接受和发送信号。（半双工的意义在于使用一条主线完成收发操作）。</span></p><p><span>上述结构完成了对全双工串口到半双工的改造。（当DIRECTION_PORT高电平使，TXD可使用，低电平时，RXD可使用）</span></p><h4 id='异步通信和同步通信'><span>异步通信和同步通信</span></h4><p><span>串行通信按照串行数据的</span><strong><span>时钟控制方式</span></strong><span>分为</span><strong><span>异步通信</span></strong><span>和</span><strong><span>同步通信</span></strong><span>。</span></p><h5 id='1异步通讯'><span>1.异步通讯</span></h5><p><span>对于异步通讯，数据通常以</span><strong><span>字节（8个bit）为单位</span></strong><span>组成字符帧传送。字符帧由发送端逐帧发送，通过传输线被接收设备逐帧接收。发送端和接收端可以由</span><strong><span>各自的时钟</span></strong><span>来控制数据的发送和接收，</span><strong><span>两个时钟源彼此独立</span></strong><span>，</span><strong><span>互不同步</span></strong><span>。</span></p><p><span>在异步通信中，通信中两个字符（8位）之间的时间间隔是</span><strong><span>不固定</span></strong><span>的，而在一个字符内各位的时间间隔是</span><strong><span>固定</span></strong><span>的。</span></p><p><img src="马哥代码详解.assets/异步通讯2.png" referrerpolicy="no-referrer" alt="异步通讯2"></p><p><span>为了传输一个字节的数据，异步通讯引入一个数据结构叫字符帧。</span></p><p><img src="马哥代码详解.assets/异步通讯.png" referrerpolicy="no-referrer" alt="异步通讯"></p><p><span>字符帧格式也称为数据帧，由</span><strong><span>起始位</span></strong><span>、</span><strong><span>数据位</span></strong><span>、</span><strong><span>奇偶校验位</span></strong><span>和</span><strong><span>停止位</span></strong><span>4部分构成。</span></p><p><span>① </span><strong><span>起始位</span></strong><span>：位于字符帧开头，只占1位，始终为逻辑0低电平，用于向接收设备表示发送端开始发送一帧信息。（这个处理就是为了同步）</span></p><p><span>② </span><strong><span>数据位：</span></strong><span>紧跟起始位之后，用户根据情况可以取5位、6位、7位和8位，低位在前高位在后。若所传数据位ASCII字符，则常取7位。</span></p><p><span>③ </span><strong><span>奇偶校验位：</span></strong><span>位于数据位之后，仅占1位，用于表征串行通信中采用奇校验位还是偶校验，由用户根据需要决定。（这里的奇偶检验位目的是为了检测所收到的消息是否和发出的消息一致，奇偶校验位是达成这种检验目的的最简单的一种方法，</span><strong><span>其核心在于计数传递的8个bit中“1”的数目是奇数还是偶数</span></strong><span>。</span></p><p><span>举个例子：奇校验就是让原有数据序列中（和要加上的一位）1的个数为奇数。</span></p><p><span>如01000110【0】，需添0。（原有3个1，奇数个，所以添0，之后1的个数还是奇数个。）</span></p><p><span>如01000111【1】，需添1。（原有4个1，偶数个，所以添1，之后1的个数是偶数个。）</span></p><p><span>因为采用了奇校验，发送端发送的</span><strong><span>”一个字节+1检验位 = 9个bit“</span></strong><span>中（含校验位），“1”的个数一定为奇数个，在接收端对二进制位中的“1”的个数进行统计，若统计出“1”的个数为偶数个，则意味着传输过程中有1位（或奇数位）发生错误。</span></p><p><span>当然既然原理这么简单，他误判的概率也很大，他只能判断是否少了，不能判断是否错位，而且对于两位数据的错误没有判断能力（出现两次0变1或者1变0不改变奇偶））</span></p><p><span>④ </span><strong><span>停止位：</span></strong><span>位于字符帧末尾，为逻辑高电平1，通常可取1位、1.5位或2位，用于向接收端表示一帧字符信息已发送完毕，也为发送下一帧字符做准备。</span></p><p><span>对于</span><strong><span>起始位和停止位</span></strong><span>：平时，发送线为高电平（逻辑1），每当接收端检测到传输线上发送过来低电平逻辑0（字符帧的起始位）时，就知道发送端已经开始发送，每当接收端接收到字符帧中的停止位时，就知道一帧字符信息已发送完毕。</span></p><p><span>接着那么就有人会问了，如果我发的消息是00001111，那么展现在电平上就是一半高电平一半低电平，那我的接收端怎么知道这一段高电平包含了多少位数据1呢，这里就要介绍一个很重要的概念——波特率。</span></p><p><strong><span>波特率</span></strong><span>的定义为每秒钟传送码元的数目，（官方一点：波特率是指数据信号对载波的调制速率，它用单位时间内载波调制状态改变的次数来表示。</span><strong><span>学过信号与系统的载波应该会理解</span></strong><span>）单位为：符号/秒或者symbol/s。那么什么是码元呢？</span></p><p><strong><span>码元</span></strong><span>在</span><strong><span>M进制</span></strong><span>数字通信系统中代表该进制体系下的符号，若为4进制，那么码元就有4种（0，1，2，3）</span></p><p><img src="马哥代码详解.assets/码元.png" referrerpolicy="no-referrer" alt="码元"></p><p><span>这里为了不弄混我们同时介绍一个概念叫</span><strong><span>比特率</span></strong><span>，</span><strong><span>比特率</span></strong><span>的定义为每秒钟传送比特的数目，单位为：bit/s。</span></p><p><span>那么两者的区别和联系也很明显了，在二进制体系下，比特率等于波特率。在四进制体系下，传输一个四进制的符号信息量，等于传输了两个二进制符号所携带的信息量，因此当波特率为9600时，比特率为19200bit/s。</span></p><p><span>这里还有一个概念用的比较多——</span><strong><span>带宽</span></strong><span>，在通讯体系下，带宽是指在规定时间内从一端流到另一端的信息量，即数据传输率,常用的单位为比特率。</span></p><p><strong><span>所以对于两个设备串行通讯的基本准则就是波特率要一致。</span></strong></p><p><span>如果波特率相同</span></p><p><img src="马哥代码详解.assets/0708967a-beba-11ec-9e50-dac502259ad0.gif" referrerpolicy="no-referrer" alt="异步通讯"></p><p><span>如果波特率不同</span></p><p><img src="马哥代码详解.assets/071ab4c2-beba-11ec-9e50-dac502259ad0.gif" referrerpolicy="no-referrer" alt="异步通讯"></p><p>&nbsp;</p><h5 id='2同步通讯'><span>2.同步通讯</span></h5><p><span>同步通信是一种连续串行传送数据的通信方式，一次通信只传送一帧信息。每个信息帧用同步字符作为开始，字符间不加标识位。</span><strong><span>（这里的数据帧比异步通信中的字符帧要大得多，通常含有若干个数据字符）</span></strong><span>。当检测到有一串数位和同步字符相匹配时，就认为开始一个信息帧，于是，把此后的数位作为实际传输信息来处理。从另一个角度讲：同步传输不是对每个字符单独进行同步，而是对一个数据块进行同步 。</span></p><p><img src="马哥代码详解.assets/同步通讯.png" referrerpolicy="no-referrer" alt="同步通讯"></p><p>&nbsp;</p><p><strong><span>同步字符：</span></strong><span>同步字符位于帧结构开头，用于确认数据字符的开始（接收端不断对传输线采样，并把采样到的字符和双方约定的同步字符比较，只有比较成功后才会把后面接收到的字符加以存储）。根据同步字符的数目分为单同步数据帧和双同步数据帧。上述图片为双同步数据帧。</span></p><p><span>对于这里的同步字符我们再补充一点：我们实际操作的其实是数据块的部分，至于同步字符的选取就涉及了底层硬件驱动的部分，是一般底层硬件驱动帮我们处理好的。常见的标准是</span><strong><span>BSC</span></strong><span>（字符同步）：同步字符记为SYN，代码为0010110)，并且通过位填充或字符填充技术保证数据块中的数据不会与同步字符混淆。</span></p><p><img src="马哥代码详解.assets/同步字符.png" referrerpolicy="no-referrer" alt="同步字符"></p><p><strong><span>数据字符：</span></strong><span>数据字符在同步字符之后，个数不受限制，由所需传输的数据块长度决定，所以说传递效率很高。</span></p><p><strong><span>校验字符CRC：</span></strong><span>校验字符有1~2个，位于帧结构末尾，用于接收端对接收到的数据字符的正确性进行校验。</span></p><p><span>这里的</span><strong><span>CRC校验</span></strong><span>也不需要我们自己写，这些函数写在了STM32的库函数里，在配置的时候：</span></p><p><img src="马哥代码详解.assets/CRC.png" referrerpolicy="no-referrer" alt="CRC"></p><p><span>有对应的寄存器操作，如上图所示。</span></p><p><span>但是当我们脱离了STM32的这个系统我们就需要自己去写</span><strong><span>CRC校验</span></strong><span>（巧了，我们还真写过，之后会讲，所以我们需要科普一下CRC的原理）</span></p><p><strong><span>CRC</span></strong><span>即循环冗余校验码，是数据通信领域中最常用的一种查错校验码，其核心在于使用</span><strong><span>二进制模2除法</span></strong><span>，在要发送的帧后面附加一个数（这个数就是我们计算出来的校验序列），这样产生的新帧将被发送给接收端。（</span><strong><span>举个例子</span></strong><span>：在发送端，先把数据划分为组，假定每组k个比特。现假定待传送的数据M=101001（k=6）。CRC运算就是在数据M的后面添加供差错检测用的n位冗余码，然后构成一个帧发送出去，一共发送（k+n）位。）</span></p><p><span>当然，这个附加的数不是随意的，至于他是如何产生的，我们先需要介绍</span><strong><span>二进制模2除法</span></strong><span>：</span></p><p><span>“模2除法”与“算术除法”类似，但它既不向上位借位，也不比较除数和被除数的相同位数值的大小，只要以相同位数进行相除即可，他遵守的法则是：模2加法运算为：1+1=0，0+1=1，0+0=0。和模2减法运算为：1-1=0，0-1=1，1-0=1，0-0=0。</span><strong><span>相当于二进制中的逻辑异或运算。</span></strong></p><p><span>下图为模二除法中的商和余数的概念</span></p><p><img src="马哥代码详解.assets/模2除法.png" referrerpolicy="no-referrer" alt="模2除法"></p><p><span>模二除法遵循三个法则：</span></p><p><span> 1、除数与被除数最高几位（与除数位数相同）做异或。余数首位是1就商1，是0就商0。（除数首位必须为1） </span></p><p><span> 2、余数先去掉首位，若此时余数最高位为1，商1，并对以它为除数继续模2除。 </span>
<span>     若最高位为0，则商0，重复步骤2。 </span></p><p><span> 3、直到余数位数小于除数位数时，运算结束。 </span></p><p><img src="马哥代码详解.assets/模2除法2.png" referrerpolicy="no-referrer" alt="模2除法2"></p><p><strong><span>为什么使用模2运算</span></strong><span>：假如一个数k被任意的数除，那么它产生的余数必定是在[0,n)区间中。即x mod n  ∈ [0, n)。模2运算也是符合这种理论的，即模2运算就是指结果只能是在[0,2)区间中取整数值的运算，显然&quot;模2运算&quot;就是指结果只能为0、1的</span><strong><span>特殊二进制运算</span></strong><span>。</span></p><p><span>除了模二除法，我们也要习惯一个概念用多项式表示序列（</span><strong><span>这个序列就是我们一会会用到的除数</span></strong><span>）</span></p><p><span>CRC-4：X^4 + X^3 + 1表示序列11001</span></p><p><span>CRC-8：x^8 + x^5 + x^4 + 1表示序列100110001 </span></p><p><span>总结一下：</span></p><p><span>1.序列的总位数等于最高位的幂次加1，即4+1=5</span></p><p><span>2.多项式只列出二进制值为1的位，也就是这个二进制的第5位、第4位、第0位的二进制均为1，其它位均为0</span></p><p><span>那么现在我们就来介绍整个CRC校验的步骤：</span></p><p><strong><span>我们选择用一个例题来讲解：</span></strong></p><p><span>现假设选择的CRC生成多项式为G（X） = X4 + X3 + 1，要求出二进制序列10110011的CRC校验码。下面是具体的计算过程：</span></p><ol start='' ><li><span>首先把生成多项式转换成二进制数，由G(X)= X4 + X3 + 转化得到11001。</span></li><li><span>除数的位数为5，CRC校验码的位数为4（校验码的位数比生成多项式的位数少1）。在原数据帧10110011后面再加4个0，得到101100110000，然后把这个数以“模2除法”方式除以多项式代表的序列，得到的余数（即CRC码）为0100</span></li></ol><p><img src="马哥代码详解.assets/CRC例题.png" referrerpolicy="no-referrer" alt="CRC例题"></p><p><span>3.把上步计算得到的CRC校验</span><strong><span>0100</span></strong><span>替换原始帧10110011</span><strong><span>0000</span></strong><span>后面的四个“0”，得到新帧10110011</span><strong><span>0100</span></strong><span>。这个就是我们得到的新帧，再把这个新帧发送到接收端。</span></p><p><span>4.当以上新帧到达接收端后，接收端会把这个新帧再用上面选定的除数11001以“模2除法”方式去除，验证余数是否为0，如果为0，则证明该帧数据在传输过程中没有出现差错，否则出现了差错。</span></p><p><strong><span>CRC校验的好处</span></strong></p><p><a href='https://www.cnblogs.com/forget406/p/5533133.html'><span>CRC检错技术原理 - forget406 - 博客园 (cnblogs.com)</span></a><span>（有能力可以看，我实在是懒的看）</span></p><p><span>总之，在接收端对收到的每一帧经过CRC检验后，有以下两种情况：</span></p><p><span>　　1）若得出的余数R=0，则判定这个帧没有差错，即接受（accept）；</span></p><p><span>　　2）若余数R!=0，则判定这个帧有差错，即丢弃（discard）。　　</span></p><p><span>循环冗余检验虽然不能保证100%正确，但是可以说接近100%</span></p><p><span>而我们的</span><strong><span>奇偶校验法</span></strong><span>的检错率只有50%，因为只有奇数个数据位发生变化能检测到，</span><strong><span>如果偶数个数据位发生变化，奇偶校验方式不能检测出错误。</span></strong><span>但是实现起来方便简单，被广泛运用。</span></p><p><span>我们再次回顾一下同步通讯的要求：同步通信要求发送和接收双方在进行数据传输时，保持完全的同步，因此，要求发收双方必须使用同频同相的同步时钟信号。所以同步通讯的接收方和发送方需要有一条同步时钟线来统一时钟信号：</span></p><p><img src="马哥代码详解.assets/同步时钟.png" referrerpolicy="no-referrer" alt="同步时钟"></p><p><span>那么你就会问了：如果在异步通讯加入一个同步时钟，能不能起到这样的效果？（自然不能，首先异步通讯时钟源不同，他们的时钟频率会有稍稍不同，其次振荡的偏移也不同，不能做到同步）对于同步通信,双方时钟的允许误差较小;异步通信简单,双方时钟可允许一定误差。</span></p><p><span>最后总结对比一下两者的不同（看完上面的讲解应该对这个表比较熟悉）</span></p><p><img src="马哥代码详解.assets/串并对比.png" referrerpolicy="no-referrer" alt="串并对比"></p><h3 id='3通讯的物理层'><span>3.通讯的物理层</span></h3><p><span>其实对于通讯协议，官方点的说法可以分为两层</span><strong><span>物理层</span></strong><span>和</span><strong><span>协议层</span></strong><span>：</span></p><p><span> </span><strong><span>协议层</span></strong><span>主要</span><strong><span>规定通讯逻辑</span></strong><span>，统一收发双方的数据打包、解包标准。包括我们之前讲的起始位，数据位（8bit）、校验位、停止位。</span></p><p><span> </span><strong><span>物理层</span></strong><span>规定通讯系统中具有机械、电子功能部分的特性，</span><strong><span>确保原始数据在物理媒体的传输</span></strong><span>，这就是我们接下来要介绍的。</span></p><p><span>我们依然建立在之后介绍的都是串行通讯：</span></p><p><span>我们传递信息使用的信号线上电平的高低，根据码元的进制（之前有讲），将不同高低的电平翻译成不同bit信息。那如何传递电平信息是我们要考虑的第一个问题：</span></p><p><span>差分信号和单端信号</span></p><p><span>单端输入指信号有一个参考端和一个信号端构成，参考端一般为地端。(一定要有参考端)</span></p><p><img src="马哥代码详解.assets/单端信号.png" referrerpolicy="no-referrer" alt="单端信号"></p><p><span>我们有两个阈值，高于VH为1，低于VL为0</span></p><p><span>差分信号其实就是把两个单路信号的差值经行传输或者输入输出处理。其比单路信号输入的优势在于，当空间环境中出现干扰源的时候（比如电机启动时候产生的辐射脉冲，会很容易影响到单路信号传输）。但对于差分信号，这种干扰就基本可以消除，因为当收到干扰的时候，差分信号的两路信号都受到干扰，电压值都会同时升高或者降低，此时他的差值却没有多少变化。</span></p><p><img src="马哥代码详解.assets/差分信号.png" referrerpolicy="no-referrer" alt="差分信号"></p><p><span>解决了传输问题，我们接下来就需要解决如何规定多高的电平是1，多低的电平是0</span></p><p><span>对应不同的通讯方式有各自对应的不同的电平规范，有的通讯协议电平规范多，有的就比较统一，规范比较少。</span></p><p><span>比如：CAN通讯就有两种电平规范ISO11898和ISO11519-2</span></p><p><img src="马哥代码详解.assets/CAN电平.png" referrerpolicy="no-referrer" alt="CAN电平"></p><p><span>对于</span><strong><span>串口通讯</span></strong><span>（和串行通讯区分开来，虽然两者很像串口是串行接口（serial port）的简称，采用串行通信协议，是其一种实现方式）</span></p><p><span>串口按电气标准及协议来划分，包括</span><a href='http://www.elecfans.com/tags/rs/'><span>RS</span></a><span>-232-C、RS-422、RS485、TTL等。</span></p><p><span>TTL电平：+5V表示1，0V表示0</span></p><p><span>RS232电平：-3 ~ -15V表示1，+3 ~ +15V表示0</span></p><p><span>RS485电平：两线压差+2 ~ +6V表示1，-2 ~ -6V表示0（差分信号）</span></p><p><span>所以对于不同的硬件之间的通讯一般会有转化芯片来做电平规则的适配</span></p><p><img src="马哥代码详解.assets/电平转化.png" referrerpolicy="no-referrer" alt="电平转化"></p><p><span>在上面的通讯方式中，两个通讯设备的&quot;DB9接口&quot;之间通过串口信号线建立起连接，串口信号线中使用&quot;RS-232标准&quot;传输数据信号。由于RS-232电平标准的信号不能直接被控制器直接识别，所以这些信号会经过一个&quot;电平转换芯片&quot;转换成控制器能识别的&quot;TTL校准&quot;的电平信号，才能实现通讯。</span></p><h2 id='三can消息收发------canmanagercanmsgdispatcher和canmsghandler'><span>三.Can消息收发——CanManager，CanMsgDispatcher和CanMsgHandler</span></h2><h3 id='1什么是can'><span>1.什么是can</span></h3><p><span>我们先从头开始介绍一下can信号，CAN 是 Controller Area Network 的缩写（以下称为 CAN），是 ISO 国际标准化的</span><strong><span>串行通信</span></strong><span>协议（回顾一下之前将的东西，can通讯是一种异步，半双工通讯）。</span></p><p><span>和所有通讯协议一样，我们先来分析它的物理层，怎么传输can信号。（我们之前讲过了：同一种通讯协议有不同的电平准则，对于can通讯，分为：ISO11898标准和 ISO11519-2 标准，。其中 ISO11898是针对通信速率为 125Kbps~1Mbps 的高速通信标准，而 ISO11519-2 是针对通信速率为 125Kbps以下的低速通信标准。</span><strong><span>而我们比赛用的硬件体系一般都保持着：1M波特率，所以后面的所有介绍都是建立在ISO11898标准标准下。</span></strong><span>）</span></p><h4 id='1差分信号'><span>1.差分信号</span></h4><p><strong><span>差分信号</span></strong><span>又称为差模信号。它采用</span><strong><span>两根振幅相等</span></strong><span>，</span><strong><span>相位相反</span></strong><span>的信号线，通过两根信号线的</span><strong><span>电压差值</span></strong><span>来表示信号。</span><img src="马哥代码详解.assets/CAN通讯电平.png" referrerpolicy="no-referrer" alt="CAN通讯电平"></p><p><span>CAN_H-CAN_L &lt; 0.5V 时候为隐性的，逻辑信号表现为&quot;逻辑1&quot;- 高电平。</span></p><p><span>CAN_H-CAN_L &gt; 0.9V 时候为显性的，逻辑信号表现为&quot;逻辑0&quot;- 低电平。</span></p><p><span>首先解释一下什么叫隐性电平，什么叫显性电平？can通讯的连接方式如下图所示:</span></p><p><img src="马哥代码详解.assets/can通讯网络.png" referrerpolicy="no-referrer" alt="can通讯网络"></p><p><span>这里的Node是通讯节点（这些节点可以发can消息，也可以收can消息，对应到我们使用的硬件上就是：STM32_RM官方A板（用can信号控制电机）或者C620电调（用can信号发送电机反馈值））。如上图所示，所有节点都被接入到整个网络里，那么所有节点传递的电平信号就会叠在一起（因为这种并联接法），即只要有一个单元输出显性电平，总线上即为显性电平。而隐形电平则具有包容的意味，只有所有的单元都输出隐性电平，总线上才为隐性电平（显性电平比隐性电平更强）。所以我们说：CAN总线在电平传输上，具有仲裁判断逻辑，优先级为：显性（低电平）&gt;隐形（高电平）。</span></p><p><span>（这里我第当时入队一次看的时候很迷惑：为什么隐形代表的是逻辑1，显性代表的是逻辑0，这样设计是有依据的——与后面要介绍的仲裁判断的优先级有联系）</span></p><p><span>最后介绍一下差分信号有什么优点：</span></p><p><span>相对于单信号线传输的方式，使用差分信号传输</span><strong><span>1.抗干扰能力强</span></strong><span>（当外界存在噪声干扰时，几乎会同时耦合到两条信号线上，而接收端只关心两个信号的差值，所以外界的共模噪声可以被完全抵消。）</span><strong><span>2.有效抑制电磁干扰</span></strong><span>，</span><strong><span>3.时序定位精确</span></strong><span>（由于差分信号的开关变化是位于两个信号的交点，而不像普通单端信号依靠高低两个阈值电压判断，因而受工艺，温度的影响小，能降低时序上的误差）</span></p><h4 id='2终端电阻'><span>2.终端电阻</span></h4><p><span>第一个抽象的东西来了！！！</span></p><p><span>终端电阻就是上面那个can通讯网络两端接入的两个120Ω的电阻。</span></p><p><strong><span>终端电阻的作用</span></strong></p><p><span>1、提高抗干扰能力，让高频低能量的信号迅速走掉</span></p><p><span>2、确保总线快速进入隐性状态，让寄生电容的能量更快走掉；</span></p><p><span>3、提高信号质量，放置在总线的两端，让反射能量降低。</span></p><p><span>其原理简述一下</span><strong><span>高频信号传输时，信号波长相对传输线较短，那么信号就会在传输线末端产生反射，在长线信号传输时，一般为了避免信号的反射和回波，也需要在接收端接入终端匹配电阻。</span></strong><span>（考虑到这里面涉及到了电磁场与微波知识我不过多做解释，有兴趣可以去看</span><a href='https://view.inews.qq.com/k/20211012A01UEM00?web_channel=wap&amp;openApp=false&amp;f=newdc'><span>CAN总线的终端电阻什么作用？ (qq.com)</span></a><span>）</span></p><p><span>这里贴一点图大家可以直观看到接没接终端电阻的影响。</span></p><p><span>1.未接终端电阻可能导致差模干扰的没有地方能够吸收掉他们，那么就会在总线上创造一个显性位出来，总线隐性时的抗干扰能力下降</span></p><p><span>2.未接终端电阻可能导致隐性电平恢复很慢</span></p><p><img src="马哥代码详解.assets/can终端电阻1.png" alt="can终端电阻1" style="zoom:80%;" /></p><p><span>下面为接入终端电阻后：</span></p><p><img src="马哥代码详解.assets/can终端电阻2.png" alt="can终端电阻2" style="zoom:80%;" /></p><p><span>3.未接终端电阻解决不了回波反射的问题</span></p><p><img src="马哥代码详解.assets/can终端电阻3.png" alt="can终端电阻3" style="zoom:80%;" /></p><p><span>下面为接入终端电阻后：</span></p><p><img src="马哥代码详解.assets/can终端电阻4.png" alt="can终端电阻4" style="zoom:80%;" /></p><p><strong><span>经验之谈+理论分析（可能是在扯淡）</span></strong></p><p><span>我们先介绍一下我们所使用的can通讯网络。我之前讲过：我们的can网络里基本上只有两个东西：STM32_RM官方A板（用can信号控制电机），C620电调（用can信号发送电机反馈值），其实STM32_RM官方A板里面的can模块默认接入120Ω终端电阻，所以我们能操作的终端电阻集中在电调上面。</span></p><p><span>下图为电机电调连接图：(对于这个体系，C620电调就是我们的can网络节点)</span></p><p><img src="马哥代码详解.assets/电机电调连线.png" alt="电机电调连线" style="zoom:50%;" /></p><p><span>在C620上有个开关能选择是否接入120Ω终端电阻：</span></p><p><img src="马哥代码详解.assets/C620电调.png" referrerpolicy="no-referrer" alt="C620电调"></p><p><span>在C620电调文档中介绍了这一句话：通过拨动开关至ON/OFF位置，可接入／断开120Ω终端电阻（用户可参阅CAN总线布线和终端电阻选择的相关规范，选择终端电阻是否接入），这句话就比较模棱两可了。这里就只能讲点经验之谈，总结成以下几个规则。</span></p><p><span>1.一律先不接终端电阻。</span></p><p><span>2.如果出现了can通讯失败，通过示波器观察差分信号，如果波形出现上面讲的一系列问题（肯定是终端电阻的锅），将整个can网络相距最远的两个can节点对应的终端电阻接入。</span></p><p><span>3.如果波形还有问题，从两端向中间的节点一点一点的接入终端电阻，同时观察差分信号波形。</span></p><p><span>至于为什么这么干我们先介绍几个受害者的案例：</span></p><p><strong><span>受害者1</span></strong></p><p><img src="马哥代码详解.assets/终端电阻受害者1.png" referrerpolicy="no-referrer" alt="终端电阻受害者1"></p><p><strong><span>群友评价：</span></strong></p><p><img src="马哥代码详解.assets/群友评价1.png" referrerpolicy="no-referrer" alt="群友评价1"></p><p>&nbsp;</p><p><strong><span>受害者</span></strong></p><p><img src="马哥代码详解.assets/image-20230217145009633.png" referrerpolicy="no-referrer" alt="image-20230217145009633"></p><p><img src="马哥代码详解.assets/image-20230217145042463.png" referrerpolicy="no-referrer" alt="image-20230217145042463"></p><p><span>总之总结成一句话：一般不会出问题，只有节点过多，can连接线过长才会涉及到终端电阻的选取，遵循循序渐进一个个，从远到近接入的原则即可。具体连接图如下图所示（我们的can网络是“手拉手”构型）</span></p><p><img src="马哥代码详解.assets/终端电阻接发.png" referrerpolicy="no-referrer" alt="终端电阻接发"></p><h4 id='3硬件结构硬件要听听）'><span>3.硬件结构（硬件要听听）</span></h4><p><img src="马哥代码详解.assets/can硬件.png" referrerpolicy="no-referrer" alt="can硬件"></p><p><span>STM32拥有的外设叫做：CAN控制器，它负责CAN通信的筛选、优先级、仲裁等问题。can控制器信号的传入是通过复用两个GPIO以后，它延伸出两个引脚：CAN_RX和CAN_TX（并不是我们所常说的CAN_H和CAN_L）类比串口我们知道一个负责收一个负责发。</span></p><p><span>在硬件层面这两个引脚上传输的数据已经是CAN报文了，该有的格式它都有。但并不是以差分信号的模式，而实现这个作用的就是CAN收发器——把来自STM32的信号转换成差分信号让电调听得懂，把来自电调的差分信号转换成STM32听得懂的信号。</span></p><h4 id='4can通讯详解can通信讲解---知乎-zhihucom'><span>4.Can通讯详解</span><a href='https://zhuanlan.zhihu.com/p/538834760'><span>CAN通信讲解 - 知乎 (zhihu.com)</span></a></h4><p><span>这里我们一边介绍can报文的结构（这里的报文是信号层面的0，1我们暂且不谈差分信号）一边配置can通讯。</span></p><p><span>一整个can报文主要分为5种帧类型（数据帧是什么可以看看前面的）：</span></p><p><img src="马哥代码详解.assets/帧类型.png" referrerpolicy="no-referrer" alt="帧类型"></p><p><span>其中，</span><strong><span>遥控帧也常被称为远程帧（这两个名字通常混用）</span></strong><span>。CAN的应用开发者只能使用“数据帧”和“遥控帧”，其他的3种帧类型是由CAN的底层固件自动帮我们在特定场景下进行收发，开发者无需担心也无法直接参与控制。而</span><strong><span>遥控帧</span></strong><span>只是CAN网络里的某一节点发送用来</span><strong><span>请求其他的节点反馈数据给自己</span></strong><span>我们基本上不用，</span><strong><span>数据帧</span></strong><span>也就是我们最常用的帧类型，用于数据的收发；也是CAN通信里最主要的内容。（我们之后只讲数据帧）。</span></p><p><strong><span>数据帧的格式</span></strong></p><p><span>数据帧有两种格式：标准格式和扩展格式。这两个格式都一共分为7个作用段，只是不同格式的7个作用段的设计不同。</span></p><p><img src="马哥代码详解.assets/不同格式.png" referrerpolicy="no-referrer" alt="不同格式"></p><h5 id='41帧起始与振结束'><span>4.1帧起始与振结束</span></h5><p><img src="马哥代码详解.assets/帧起始.png" referrerpolicy="no-referrer" alt="帧起始"></p><p><span>我们知道所有can节点都接到一个can网络上，那么所有can节点的CAN_RX上收到的信息都是一样的。那总么线空闲是怎么判断的呢？</span></p><p><span>判断总线状态可以监测总线电压，简单来说CAN_H和CAN_L之间的差分电压大的（一般在2V左右）就是显性状态，差分电压小的（理论上是0V）就是隐性。当你一值监测到总线都处于隐性状态（就是两根线电压值差不多）那就说明总线处于空闲状态，如果是显隐交替，那就是总线不处于空闲状态（就说明有节点在发消息）。</span></p><p><span>　　CAN总线空闲的定义是连续11个位的隐性电平（逻辑为1）。而CAN的显性电平逻辑为0，一旦有显性就说明肯定至少有1个节点在发送波形，那就不是空闲了。</span></p><p><strong><span>这也就是为什么帧起始是显性电平，帧结束是隐形电平的原因</span></strong><span>（至于为什么空闲时间是隐形电平，理由也很明显：显性电平会覆盖掉隐形电平，即使这个时间段有节点想发送隐形电平，也会被总线的显性电平覆盖掉，就不能脱离空闲状态）</span></p><h5 id='42仲裁段和仲裁机制'><span>4.2仲裁段和仲裁机制</span></h5><p><strong><span>仲裁机制</span></strong></p><p><strong><span>只要总线空闲，总线上任何节点都可以发送报文</span></strong><span>，如果有两个或两个以上的节点开始传送报文，那么就会存在总线访问冲突的可能。但是CAN使用了标识符的逐位仲裁方法可以解决这个问题。帧ID越小，优先级越高。</span></p><p><img src="马哥代码详解.assets/总线仲裁.png" referrerpolicy="no-referrer" alt="总线仲裁"></p><p><span>CAN总线控制器在发送数据的同时监控总线电平。对于一个节点：CAN_TX上的信号是他期望发送的信号；而CAN_RX则是检测总线上的电平（即依据显隐形各个节点CAN_TX发送的信号叠加在一起的信号）</span></p><p><span>我们从上面的图中可以得到，节点B因为第6位想发送的是隐形电平而节点A发送的第六位为显性电平，那么节点B的CAN_RX收到的第六位将被覆盖为显性电平与他想发送的不一致于是则进入只听模式。</span></p><p><span>总结一下对于一个节点如果收发线的信号电平不同，则停止发送并做其他处理。如果该位位于仲裁段，则退出总线竞争；如果位于其他段，则产生错误事件。</span></p><p><span>这里就回答了之前的问题为什么隐形电平代表的是逻辑1（只是一部分原因），为了满足显性电平覆盖隐形电平的仲裁机制和ID越小，优先级越高的规律，隐形电平只能表示逻辑1。</span></p><p><strong><span>仲裁段</span></strong></p><p><img src="马哥代码详解.assets/仲裁段.png" referrerpolicy="no-referrer" alt="仲裁段"></p><p><span>RTR位：用于指示这包数据是遥控帧（远程帧）还是数据帧，数据帧的RTR位为显性电平，远程帧（遥控帧）为隐性电平（但还是优先ID判断）。所以帧格式和帧ID相同的情况下，数据帧优先于远程帧。</span></p><p><span>IDE位：用于指示这包数据是标准格式还是扩展格式，标准格式的IDE位为显性电平，扩展帧格式的IDE位为隐形电平。那么对于前11位ID相同的标准帧和扩展帧，标准帧优先级比扩展帧高。</span></p><p><span>这里注意一下标准格式里，仲裁段没有IDE位，其实这个位在标准格式里是放在控制段的第一位的，这样就正好可以和扩展格式的IDE位对应上进行仲裁了。（了解就行，我感觉没什么意义，把IDE归到仲裁段也行，估计是为了保持仲裁段的格式ID开始PTR结尾）</span></p><p><span>扩展格式的意义在于增加ID的位数进行更多的节点选择，同时保证能和标准格式一起仲裁。</span></p><h5 id='43控制段'><span>4.3控制段</span></h5><p><img src="马哥代码详解.assets/控制段.png" referrerpolicy="no-referrer" alt="控制段"></p><p><span>在这里可以看到，在标准格式里，IDE位放到了控制段的第一位来了，对应前文仲裁段的内容，就可以使标准格式与扩展格式进行仲裁了。保留位（ r0 、 r1 ）：保留位必须全部以隐性电平发送。</span></p><p><span>数据长度码（ DLC ）：数据的字节数必须为 0 ～ 8 字节。数据帧的DLC表示的就是当前包数据段所带的字节数，遥控帧的DLC表示的是请求返回的数据长度。</span></p><h5 id='44数据段'><span>4.4数据段</span></h5><p><img src="马哥代码详解.assets/数据段.png" referrerpolicy="no-referrer" alt="数据段"></p><h5 id='45crc段'><span>4.5CRC段</span></h5><p><img src="马哥代码详解.assets/CRC段.png" referrerpolicy="no-referrer" alt="CRC段"></p><p><span>CAN-bus使用CRC校验进行数据检错，CRC校验值存放于CRC段。 CRC校验段由15位CRC值和1位CRC界定符构成如上图（CRC原理如上图），而CRC多项式的选择就是上图多项式。</span></p><h5 id='46ack段'><span>4.6ACK段</span></h5><p><img src="马哥代码详解.assets/ACK段.png" referrerpolicy="no-referrer" alt="ACK段"></p><p><span>当一个接收节点接收的帧起始到CRC段之间的内容没发生错误时，它将在ACK段发送一个显性电平。</span></p><h5 id='47科普位填充'><span>4.7科普位填充</span></h5><p><img src="马哥代码详解.assets/位填充.png" referrerpolicy="no-referrer" alt="位填充"></p><ul><li><span>对于发送节点而言：</span></li></ul><p><span>在发送数据帧和遥控帧时，对于SOF~CRC(除去CRC界定符) 之间的位流，相同极性的电平如果持续5位，那么在下一个位插入一个与之前5位反型的电平；</span></p><ul><li><span>对于接收节点而言：</span></li></ul><p><span>在接收数据帧和遥控帧时，对于SOF~CRC(除去CRC界定符)之间的位流，相同极性的电平如果持续5位，那么需要删除下一位再接收。如果这个第 6 个位的电平与前 5 位相同，将被视为错误并发送</span><strong><span>位填充错误帧</span></strong><span>。</span></p><h5 id='48can采样点与波特率'><span>4.8CAN采样点与波特率</span></h5><p><span>我们再次回顾一下can通讯的性质，它是一种异步通讯也就是两个设备的时钟系统不相同，虽然说两者统一了波特率，但仍会因为时钟系统的误差导致两者的不同，和我们之前讲的串行通讯不同，can通讯的一条消息包含了不止一个字节的消息，同时他还支持了CRC校验，这就导致了一条消息的长度很长，除了开头起始帧的一次同步，CAN通讯还需要设计另一种方式来进行传播中的重同步。否则过长的消息传播过程中时钟的差异会累计，这就会导致严重的后果。</span>
<img src="马哥代码详解.assets/采样点1.png" referrerpolicy="no-referrer" alt="采样点1">
<img src="马哥代码详解.assets/位时间.png" referrerpolicy="no-referrer" alt="位时间">
<span>实际上，一个高电平或者低电平的传输时间不止一个时钟周期，为了保证收发的统一，通常一个高低电平将保持很多个CAN时钟的周期，具体映射关系如下图所示：</span>
<img src="马哥代码详解.assets/采样点2.png" referrerpolicy="no-referrer" alt="采样点2">
<strong><span>我们将一个CAN时钟周期定义为tq</span></strong><span>，一个CAN位时间包含了</span><strong><span>很多个tq</span></strong><span>，在一个CAN位时间里电平都是一样的，那么收单元哪怕有时间误差（由于是时钟误差，所以误差的量纲是tq级别的，用人话说就是只可能差tq，不可能差一整个can位时间），只要时间误差不超过一个CAN位时间（很多个tq），采样的那个电平就是正确的。</span>
<span>接着我们来介绍一下这四个时间段：</span>
<strong><span>1）同步段（Synchronization Segment）：</span></strong>
<span>长度固定，1个时间量子Tq；</span>
<span>一个位的传输从同步段开始；</span>
<span>同步段用于同步总线上的各个节点，一个位的跳边沿在此时间段内。（但也不一定，如果两个位相同的话那么同步段上就不会有跳变）</span>
<strong><span>2）传播段（Propagation Segment）：</span></strong>
<span>传播段用于补偿报文在总线和节点上传输时所产生的时间延迟；</span>
<span>传播段时长 ≥ 2 × 报文在总线和节点上传输时产生的时间延迟 ；</span>
<span>传播段时长可编程（1~8个时间量子Tq）。</span>
<strong><span>3）相位缓冲段1（Phase Buffer Segment1）：</span></strong>
<span>用于补偿节点间的晶振误差；</span>
<strong><span>允许通过重同步对该段加长；</span></strong><span>（只能加长）</span>
<span>在这个时间段的末端进行总线状态的采样；</span>
<span>长度可编程（1~8个时间量子Tq）</span>
<strong><span>4）相位缓冲段2（Phase Buffer Segment2）：</span></strong>
<span>用于补偿节点间的晶振误差；</span>
<strong><span>允许通过重同步对该段缩短；</span></strong><span>（只能缩短）</span>
<span>长度可编程（1~8个时间量子Tq）</span>
<span>现在有了这些段我们就可以进行</span><strong><span>同步操作</span></strong><span>了：</span>
<strong><span>请注意！！！</span></strong>
<strong><span>只有检测在同步段产生下降沿才会有同步定位操作</span></strong><span>，若无下降沿则不进行调整，因此为了避免多个相同连续位出现导致位时序得不到调整，产生不同步的情况，CAN控制器增加了填充位的概念，当出现连续5个相同位后，添加一位相反电平的填充位（之前讲过）。</span>
<span>CAN通讯的同步分为两种：</span><strong><span>硬同步和重同步</span></strong><span>：</span>
<strong><span>1.硬同步就是我们之前将的起始帧的作用</span></strong><span>：</span>
<span>硬同步接收单元在总线空闲状态检测出第一个下降沿时（对应报文的SOF下降沿）进行的同步调整。在检测到SOF的下降沿时，直接将此下降沿的位置认为是SS段（可以理解为每次发完一条消息，总线进入空闲状态所有的节点关于位时间时间片的计数都会消失，所以对于新的消息收发流程需要重新指定SS段开始关于位时间时间片的计数)，然后按照位时序对信号进行采样，达到同步的效果。</span></p><p><strong><span>2.重同步发生在非SOF帧，其本质还是基于SS段的同步。</span></strong></p><p><span>对于一个节点，他获取总线信息是依据自己的时钟信号，换句话来说（这个节点心里有一个时间片计数，但由于系统时钟的误差，这个计数的时间可能会和真实的总线电平不一样，因为总线电平的时间片取决于发送节点的时钟，而不是接收节点的时钟，那么就会产生接受节点在总线检测到了SS段的跳变，但他的内部时间片计数认证该段不为SS段的情况，如下图所示：）</span>
<img src="马哥代码详解.assets/重同步.png" referrerpolicy="no-referrer" alt="重同步">
<span>那么我们以真实检测到的总线电平为准，接受节点将认为他的内部时间片计数错了比真实的快了两个时间片，那么采样点将会提前两个时间片，为了避免这个情况，计数器将把PSB1段延长两个时间片，那么采样点将被延迟两个时间片，一正一负刚好抵消，采样点将会和发送节点发送的保持一致。此时，发送节点NodeA和接收节点的采样点就同步了。同时下一个SS段也因为PSB1段的增加再次同步。</span>
<img src="马哥代码详解.assets/重同步2.png" referrerpolicy="no-referrer" alt="重同步2"></p><p><span>对应的发送节点如果比接收节点的时间快，故接收节点的采样点就要滞后，但是因为有PBS2的存在，采样点不会相差太大，当前本次位的采样点没法完全同步，但是为了下一位完全同步，接收节点会缩短PBS2。</span></p><p><img src="马哥代码详解.assets/重同步3.png" alt="重同步3" style="zoom:80%;" /></p><p><span>总结一下：</span></p><p><span>        PBS1和PBS2的作用主要是给采样点做一个缓冲。采样点可以暂时不完全同步，通过调整PBS1或PBS2，让采样点同步起来。</span>
<span>  PBS1和PBS2只是提供缓冲而已，不能无限的缓冲。故有一个同步跳转宽度（SJW），它表示PBS1和PBS2重同步时允许跳转的最大宽度，即SJW是PBS1延长或PBS2缩短的上限。SJW必须小于PBS1和PBS2的最小值，SJW最大值不能超过4。</span></p><h4 id='5怎么在代码上配置can通讯'><span>5.怎么在代码上配置can通讯</span></h4><h5 id='第一步初始化gpio'><strong><span>第一步：初始化GPIO</span></strong></h5><p><span>就是把我们的GPIO复用成CAN_RX和CAN_TX,我们的RobomasterA板是自带了CAN收发器的，我们外观上看到的接口，其实不是直连的CAN_RX和CAN_TX是过了CAN收发器的CAN_H和CAN_L。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//初始化GPIO</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_InitStructure</span>.<span class="cm-variable">GPIO_Pin</span> <span class="cm-operator">=</span> <span class="cm-variable">GPIO_Pin_0</span> <span class="cm-operator">|</span> <span class="cm-variable">GPIO_Pin_1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_InitStructure</span>.<span class="cm-variable">GPIO_Mode</span> <span class="cm-operator">=</span> <span class="cm-variable">GPIO_Mode_AF</span>;<span class="cm-comment">//复用功能（只有有对应CAN控制器连着的引脚才能复用成CAN功能（查表可知是GPIO_Pin_0和GPIO_Pin_1））</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_InitStructure</span>.<span class="cm-variable">GPIO_OType</span> <span class="cm-operator">=</span> <span class="cm-variable">GPIO_OType_PP</span>;<span class="cm-comment">//选择推挽输出nzi</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_InitStructure</span>.<span class="cm-variable">GPIO_Speed</span> <span class="cm-operator">=</span> <span class="cm-variable">GPIO_Speed_100MHz</span>;<span class="cm-comment">//100MZ的输出频率</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_InitStructure</span>.<span class="cm-variable">GPIO_PuPd</span> <span class="cm-operator">=</span> <span class="cm-variable">GPIO_PuPd_UP</span>;<span class="cm-comment">//上拉（以上全部可抄，基本上所有板子都一样）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_Init</span>(<span class="cm-variable">GPIOD</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">GPIO_InitStructure</span>);<span class="cm-comment">//依据上面的配置初始化GPIO</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_PinAFConfig</span>(<span class="cm-variable">GPIOD</span>, <span class="cm-variable">GPIO_PinSource0</span>, <span class="cm-variable">GPIO_AF_CAN1</span>);<span class="cm-comment">//复用功能为can</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">GPIO_PinAFConfig</span>(<span class="cm-variable">GPIOD</span>, <span class="cm-variable">GPIO_PinSource1</span>, <span class="cm-variable">GPIO_AF_CAN1</span>);<span class="cm-comment">//复用功能为can</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><h5 id='第二步配置can中断'><span>第二步：配置CAN中断</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_ITConfig</span>(<span class="cm-variable">CAN1</span>, <span class="cm-variable">CAN_IT_FMP0</span>, <span class="cm-variable">ENABLE</span>); &nbsp; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NVIC_InitStructure</span>.<span class="cm-variable">NVIC_IRQChannel</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN1_RX0_IRQn</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NVIC_InitStructure</span>.<span class="cm-variable">NVIC_IRQChannelPreemptionPriority</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN1_NVIC</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NVIC_InitStructure</span>.<span class="cm-variable">NVIC_IRQChannelSubPriority</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NVIC_InitStructure</span>.<span class="cm-variable">NVIC_IRQChannelCmd</span> <span class="cm-operator">=</span> <span class="cm-variable">ENABLE</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NVIC_Init</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">NVIC_InitStructure</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><h5 id='第三步的先验知识can的收发邮箱33条消息-stm32之can---发送管理分析bonson2004的博客-csdn博客'><span>第三步的先验知识can的收发邮箱</span><a href='https://blog.csdn.net/bonson2004/article/details/68941602'><span>(33条消息) STM32之CAN---发送管理分析_bonson2004的博客-CSDN博客</span></a></h5><p><span>每个CAN收发网络有三个can发送邮箱和两组FIFO接收邮箱</span></p><p><img src="马哥代码详解.assets/FIFO-16737773279543.png" alt="FIFO" style="zoom:80%;" /></p><p><strong><span>CAN发送邮箱</span></strong></p><p><span>STM32共有三个CAN发送邮箱，在检测到总线空闲时交发送。</span></p><p><img src="马哥代码详解.assets/can发送-16737773279545.png" referrerpolicy="no-referrer" alt="image-20221119140224709"></p><p><span>由上图可知，发送邮箱共有四种状态，空状态，挂号状态，预定发送状态（scheduled），发送状态。</span></p><p><span>发送报文的流程为：应用程序选择1个</span><strong><span>空状态</span></strong><span>发送邮箱，设定需要发送信息的属性（标识符，数据长度和待发送数据）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CanTxMsg</span> <span class="cm-variable">TxMessage</span>; &nbsp;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">i</span>; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span>(<span class="cm-variable">id_fmt</span> <span class="cm-operator">==</span> <span class="cm-variable">STD_ID</span>)<span class="cm-comment">//如果是标准CAN ID &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">TxMessage</span>.<span class="cm-variable">StdId</span> <span class="cm-operator">=</span> <span class="cm-variable">send_frame</span><span class="cm-operator">-&gt;</span><span class="cm-variable">id</span>; &nbsp;<span class="cm-comment">//设置标准CAN ID &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">TxMessage</span>.<span class="cm-variable">IDE</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_ID_STD</span>; &nbsp; <span class="cm-comment">//设置IDE为标准CAN ID &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">} &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">else</span> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">TxMessage</span>.<span class="cm-variable">StdId</span> <span class="cm-operator">=</span> (<span class="cm-variable">send_frame</span><span class="cm-operator">-&gt;</span> <span class="cm-variable">id</span> <span class="cm-operator">&gt;&gt;</span><span class="cm-number">18</span>) <span class="cm-operator">&amp;</span> <span class="cm-number">0x7FF</span>; <span class="cm-comment">//设置扩展CAN ID的标准基本ID部分 &nbsp; &nbsp; &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">TxMessage</span>.<span class="cm-variable">ExtId</span> <span class="cm-operator">=</span> <span class="cm-variable">send_frame</span><span class="cm-operator">-&gt;</span><span class="cm-variable">id</span> <span class="cm-operator">&amp;</span> <span class="cm-number">0x3FFFF</span>; &nbsp; &nbsp; <span class="cm-comment">//设置扩展CAN ID的扩展ID部分 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">TxMessage</span>.<span class="cm-variable">IDE</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_ID_EXT</span>; &nbsp; <span class="cm-comment">//设置IDE为扩展CAN ID &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">} &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">TxMessage</span>.<span class="cm-variable">RTR</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_RTR_DATA</span>; <span class="cm-comment">//数据帧 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">TxMessage</span>.<span class="cm-variable">DLC</span> <span class="cm-operator">=</span> <span class="cm-number">8</span>; &nbsp;<span class="cm-comment">//数据长度 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(<span class="cm-variable">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">i</span><span class="cm-operator">&lt;</span><span class="cm-number">8</span>;<span class="cm-variable">i</span><span class="cm-operator">++</span>)<span class="cm-operator">&lt;</span><span class="cm-variable">br</span><span class="cm-operator">&gt;</span> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{ &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">TxMessage</span>.<span class="cm-variable">Data</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">send_frame</span><span class="cm-operator">-&gt;</span><span class="cm-variable">data_buff</span>[<span class="cm-variable">i</span>]; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">} &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CAN_Transmit</span>(<span class="cm-variable">CAN1</span>,<span class="cm-operator">&amp;</span><span class="cm-variable">TxMessage</span>);<span class="cm-comment">//调用库函数发送消息</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 515px;"></div><div class="CodeMirror-gutters" style="display: none; height: 515px;"></div></div></div></pre><p><span>然后对寄存器TXRQ将会变成</span><strong><span>1</span></strong><span>，用来表示来请求发送。TXRQ置</span><strong><span>1</span></strong><span>后，邮箱就不再是</span><strong><span>空状态</span></strong><span>邮箱，而一旦邮箱不再为空，软件对邮箱寄存器就不再有写的权限。</span></p><p><span>TXRQ置</span><strong><span>1</span></strong><span>后，邮箱马上进入</span><strong><span>挂号状态</span></strong><span>，并等待成为最高优先级的邮箱。</span></p><p><span>如果三个邮箱中同时存在多个待发送的报文时，此时存在一个问题，即先送哪个邮箱中的报文好呢？此时，存在一个发送优先级的问题。此时，非空发送邮箱进入发送仲裁，发送仲裁有两种策略：ID模式和FIFO模式。</span></p><p><strong><span>ID模式</span></strong><span>：通过对CAN_MCR寄存器（CAN主控寄存器）的TXFP置</span><strong><span>0</span></strong><span>，为</span><strong><span>ID模式</span></strong><span>。当有超过1个发送邮箱在挂号时，发送顺序由邮箱中报文的标识符（ID）决定。根据CAN协议，标识符（ID）数值最低的报文具有最高的优先级。如果标识符（ID）的值相等，那么邮箱号小的报文先被发送。</span></p><p><strong><span>FIFO模式</span></strong><span>：通过对CAN_MCR寄存器（CAN主控寄存器）的TXFP置</span><strong><span>1</span></strong><span>，可以把发送邮箱配置为发送FIFO。在该模式下，发送的优先级由发送请求次序决定。（谁先请求谁先发送）</span></p><p><span>一旦邮箱成为最高优先级的邮箱，其状态就变为</span><strong><span>预定发送状态</span></strong><span>。一旦CAN总线进入空闲状态，预定发送邮箱中的报文就马上被发送(进入</span><strong><span>发送状态</span></strong><span>)。</span></p><p><span>一旦邮箱中的报文被成功发送后，它马上变为空邮箱；硬件相应地对CAN_TSR寄存器的RQCP和TXOK位置1，来表明一次成功发送。</span></p><p><span>如果发送失败，由于仲裁引起的就对CAN_TSR寄存器的ALST位置</span><strong><span>1</span></strong><span>，由于发送错误引起的就对TERR位置</span><strong><span>1</span></strong><span>。</span></p><p><strong><span>（寄存器的操作看看就行了，但有的时候要是CAN通讯寄了就要去看看寄存器的状态）</span></strong></p><p><strong><span>CAN滤波器</span></strong></p><p><span>我们在回顾一下can通讯的一个特点，多主控制，总线控制。换句话来说，所有节点受到的消息都是总线的消息。那我们如何做到一对一或者一对多的通讯呢？</span></p><p><span> 在CAN协议里，报文的标识符（ID）不代表节点的地址，而是跟报文的内容相关的。因此，发送者以广播的形式把报文发送给所有的接收者。节点在接收报文时,根据标识符(CAN ID)的值决定软件是否需要该报文；如果需要，就拷贝到SRAM里（即接收）；如果不需要，报文就被丢弃且无需软件的干预。</span></p><p><span>那么如何去辨识这些ID呢，STM32为每个CAN接收邮箱组配置了一组滤波器。</span></p><p><span>CAN的过滤器模式分为掩码模式和列表模式，列表模式简单来说就是制作一张ID表，如果来的数据的ID在这张表中则接收，否则不收。重点介绍一下掩码模式的原理：</span></p><p><span>对于机器来说，我们要为它准备好两张纸片，一片写上屏蔽码，另一片纸片写上验证码，屏蔽码上相应位为1时，表示此位需要与验证码对应位进行比较，反之，则表示不需要。机器在执行任务的时候先将获取的身份证号码与屏蔽码进行“与”操作，再将结果与验证码的进行比较，根据判断是否相同来决定是否通过。整个判别流程如下所示：</span></p><p><img src="马哥代码详解.assets/掩码-16737773279544.png" referrerpolicy="no-referrer" alt="掩码"></p><p><span>而滤波器组就是配置验证码和屏蔽码。</span></p><p><strong><span>CAN接收邮箱</span></strong></p><p><span>当bxCAN接收到报文，经过过滤器过滤后，会将报文存储到FIFO接受邮箱组里。STM32的bxCAN模式共有两个接收FIFO，其次，每个接收FIFO由3个邮箱组成。FIFO共有五个状态：空状态，挂号1状态，挂号2状态，挂号3状态，溢出状态。如下图所示：</span></p><p><img src="马哥代码详解.assets/接收-16737773279556.png" alt="接收" style="zoom:80%;" /></p><p><span>在初始化状态时，FIFO是处于空状态的，当接收到一个报文时，这个报文存储到FIFO内部的邮箱中，此时，FIFO的状态变成挂号1状态，如果应用程序取走这个消息，则FIFO恢复空状态。</span></p><p><span>现在假设FIFO处于</span><strong><span>挂号1状态</span></strong><span>，即已接收到一个报文，且应用程序不没来得及取走接收到的报文，此时若再次接收到一个报文，那么FIFO将变成</span><strong><span>挂号2状态</span></strong><span>，以此类推，由于FIFO共有3个邮箱，只能缓存3个报文，因此，当接收到3个报文（假设期间应用程序从未取走任何报文）时，此时FIFO已满，若再来一个报文时，已无法再存储，此时FIFO将变成溢出状态。</span></p><p><strong><span>1.FIFO溢出策略</span></strong></p><p><span> STM32有两种策略来处理当FIFO溢出时的报文：</span></p><p><span>一：当FIFO溢出时，首先抛弃FIFO内最老的报文，然后再存入新接收到的报文，即滚动接收模式。</span></p><p><span>二：当FIFO溢出时，抛弃新接收到的报文，即FIFO锁定模式。</span></p><p><strong><span>2.与CAN接收相关的中断</span></strong>
<span>STM32中与CAN接收相关的中断有三个：</span></p><p><span>1.接收中断：每当bxCAN接收到一个报文时产生一个中断。</span></p><p><span>2.FIFO满中断：当FIFO满时，即存储了3个报文时产生的中断。</span></p><p><span>3.FIFO溢出中断：当FIFO溢出时产生此中断。</span></p><p><span>不幸的是这些中断都只有一个中断处理函数</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">CAN1_RX0_IRQHandler</span>(<span class="cm-variable-3">void</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>所以在做中断处理的时候我们需要通过观察寄存器情况判断是哪种中断：</span></p><p><img src="马哥代码详解.assets/CAN寄存器-16737773279558.png" referrerpolicy="no-referrer" alt="CAN寄存器"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">CAN1_RX0_IRQHandler</span>(<span class="cm-variable-3">void</span>)<span class="cm-comment">//通用中断函数</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">CanRxMsg</span> <span class="cm-variable">_rxMsg</span>;<span class="cm-comment">//新建一个变量来接收message</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">CAN_GetITStatus</span>(<span class="cm-variable">CAN1</span>, <span class="cm-variable">CAN_IT_FMP0</span>) <span class="cm-operator">!=</span> <span class="cm-variable">RESET</span>)<span class="cm-comment">//关注于是否为FIFO0消息挂起中断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">CAN_ClearITPendingBit</span>(<span class="cm-variable">CAN1</span>, <span class="cm-variable">CAN_IT_FMP0</span>);<span class="cm-comment">//手动清楚中断挂起脏标</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">CAN_Receive</span>(<span class="cm-variable">CAN1</span>, <span class="cm-variable">CAN_FIFO0</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">_rxMsg</span>);<span class="cm-comment">//库函数的接收函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">CanManager::Instance</span>()<span class="cm-operator">-&gt;</span><span class="cm-variable">MsgQueue</span>(<span class="cm-number">0</span>)<span class="cm-operator">-&gt;</span><span class="cm-variable">Enqueue</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">_rxMsg</span>);<span class="cm-comment">//自己写的神之函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 269px;"></div><div class="CodeMirror-gutters" style="display: none; height: 269px;"></div></div></div></pre><h5 id='第三步配置滤波器'><span>第三步配置滤波器</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterNumber</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterMode</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_FilterMode_IdMask</span>;<span class="cm-comment">//设置为掩码模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterScale</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_FilterScale_32bit</span>;<span class="cm-comment">//设置滤波器长度为32位</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterIdHigh</span> <span class="cm-operator">=</span> <span class="cm-number">0x0000</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterIdLow</span> <span class="cm-operator">=</span> <span class="cm-number">0x0000</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterMaskIdHigh</span> <span class="cm-operator">=</span> <span class="cm-number">0x0000</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterMaskIdLow</span> <span class="cm-operator">=</span> <span class="cm-number">0x0000</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterFIFOAssignment</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_Filter_FIFO0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInitStructure</span>.<span class="cm-variable">CAN_FilterActivation</span> <span class="cm-operator">=</span> <span class="cm-variable">ENABLE</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_FilterInit</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">CAN_FilterInitStructure</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_ITConfig</span>(<span class="cm-variable">CAN1</span>, <span class="cm-variable">CAN_IT_FMP0</span>, <span class="cm-variable">ENABLE</span>);<span class="cm-comment">//把FMP0中断打开</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//我们上面说了STM32一共有两个FIFO邮箱组</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//他们的接收中断是两个CAN1_RX0_IRQHandler和CAN1_RX1_IRQHandler</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//上述的函数则是打开了FIFO0邮箱组，那么在后续的操作中中断处理函数应该是CAN1_RX0_IRQHandler</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><p><span>这里设置的为：屏蔽码设为0x00000000，无论任何标识符通过之后都变成0x00000000，验证码0x00000000，所以无论任何屏蔽码都能通过。可见其实并没有起到任何过滤作用，这是因为CAN总线上挂载的四个电调，我们的主控都需要接收其数据，所以无论来的标识符是哪个，都要照单全收，而CAN不配置完过滤器是无法开启的，所以才有这套验证码+屏蔽码都是0x00000000的操作。</span></p><h5 id='第四步配置时序和位时间和一些基本设置'><span>第四步配置时序和位时间和一些基本设置</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="C++" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint8_t</span> <span class="cm-variable">tsjw</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_SJW_1tq</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint8_t</span> <span class="cm-variable">tbs2</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_BS2_2tq</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint8_t</span> <span class="cm-variable">tbs1</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_BS1_11tq</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint16_t</span> <span class="cm-variable">brp</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">uint8_t</span> <span class="cm-variable">mode</span> <span class="cm-operator">=</span> <span class="cm-variable">CAN_Mode_Normal</span>; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_TTCM</span> <span class="cm-operator">=</span> <span class="cm-variable">DISABLE</span>;<span class="cm-comment">//非时间触发通信模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_ABOM</span> <span class="cm-operator">=</span> <span class="cm-variable">ENABLE</span>;<span class="cm-comment">//软件自动离线管理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_AWUM</span> <span class="cm-operator">=</span> <span class="cm-variable">DISABLE</span>;<span class="cm-comment">//睡眠模式通过软件唤醒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_NART</span> <span class="cm-operator">=</span> <span class="cm-variable">DISABLE</span>;<span class="cm-comment">//禁止报文自动传送</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_RFLM</span> <span class="cm-operator">=</span> <span class="cm-variable">DISABLE</span>;<span class="cm-comment">//报文不锁定,新的覆盖旧的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_TXFP</span> <span class="cm-operator">=</span> <span class="cm-variable">DISABLE</span>;<span class="cm-comment">//优先级由报文标识符决定</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_Mode</span> <span class="cm-operator">=</span> <span class="cm-variable">mode</span>;<span class="cm-comment">//模式设置 1,普通模式;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_SJW</span> <span class="cm-operator">=</span> <span class="cm-variable">tsjw</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_BS1</span> <span class="cm-operator">=</span> <span class="cm-variable">tbs1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_BS2</span> <span class="cm-operator">=</span> <span class="cm-variable">tbs2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_InitStructure</span>.<span class="cm-variable">CAN_Prescaler</span> <span class="cm-operator">=</span> <span class="cm-variable">brp</span>;<span class="cm-comment">//分频系数(Fdiv)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CAN_Init</span>(<span class="cm-variable">CAN1</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">CAN_InitStructure</span>); &nbsp; <span class="cm-comment">//初始化CAN1</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><span>具体原理详情见之前的讲解。在这里的配置需要满足一些条件：</span></p><ul><li><p><span>同步段(SYNC_SEG)：位变化应该在此时间段内发生。只有一个时间片的固定长度(1 x tq)</span></p></li><li><p><span>位段1(BS1)：定义采样点的位置。其持续长度可以在 1 到 16 个时间片之间调整</span></p></li><li><p><span>位段2(BS2)：定义发送点的位置。其持续长度可以在 1 到 8 个时间片之间调整</span></p></li><li><p><span>同步跳转宽度（SJW）：定义位段加长或缩短的上限。它可以在 1 到 4 个时间片之间调整</span></p></li><li><p><span>再满足我们的波特率公式的前提下</span></p><p><img src="马哥代码详解.assets/波特率计算-16737773279557.png" referrerpolicy="no-referrer" alt="波特率计算"></p><p><span>我们有非常多组位段1和位段2的排列组合，选择最好的排列组合如下图所示：</span></p></li></ul><p><img src="马哥代码详解.assets/波特率配置-16737773279559.png" referrerpolicy="no-referrer" alt="波特率配置"></p><p><span>具体可以参考这个博客</span><a href='https://blog.csdn.net/piaolingyekong/article/details/124276670'><span>(33条消息) CAN总线波特率的设定——以STM32为例</span><em><span>HW_Guo的博客-CSDN博客</span></em><span>stm32 can波特率</span></a></p><p><span>具体配置可以参考下面两个工具：（找老队员要），也可以手算。</span></p><p><img src="马哥代码详解.assets/can工具-167377732795510.png" referrerpolicy="no-referrer" alt="can工具"></p><p><span>给大家一个具体的流程：</span></p><p><span>首先通过这个函数获取你玩的开发板的时钟频率：</span><a href='https://blog.csdn.net/czhzasui/article/details/80238156'><span>(34条消息) stm32查看当前时钟频率_czhzasui的博客-CSDN博客</span></a></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c++"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c++"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.2px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">SYSCLK_Frequency</span>; &nbsp;<span class="cm-comment">/*!&lt; returns SYSCLK clock frequency expressed in Hz */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">HCLK_Frequency</span>; &nbsp; &nbsp;<span class="cm-comment">/*!&lt; returns HCLK clock frequency expressed in Hz */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">PCLK1_Frequency</span>; &nbsp; <span class="cm-comment">/*!&lt; returns PCLK1 clock frequency expressed in Hz */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">PCLK2_Frequency</span>; &nbsp; <span class="cm-comment">/*!&lt; returns PCLK2 clock frequency expressed in Hz */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">uint32_t</span> <span class="cm-variable">ADCCLK_Frequency</span>; &nbsp;<span class="cm-comment">/*!&lt; returns ADCCLK clock frequency expressed in Hz */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">RCC_ClocksTypeDef</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><span>再打开工具箱</span></p><p><img src="马哥代码详解.assets/can工具界面-167377732795511.png" referrerpolicy="no-referrer" alt="can工具界面"></p><p><span>输入上面看到的APB1时钟频率和需要配置的波特率，然后选取CAN采样率最大的一组选项即可（甚至还能</span><strong><span>生成代码</span></strong><span>）</span></p><h3 id='2我们的can通讯'><span>2.我们的CAN通讯</span></h3><h4 id='1先行知识'><span>1.先行知识</span></h4><h5 id='11循环队列'><span>1.1循环队列</span></h5><p>&nbsp;</p></div></div>

</body>
</html>